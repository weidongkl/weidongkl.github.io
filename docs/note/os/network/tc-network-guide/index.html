<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-note/os/network/tc-network-guide" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">TC (Traffic Control) 网络模拟 | Weidong Note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="http://weidongkl.github.io/img/weidongkl.png"><meta data-rh="true" name="twitter:image" content="http://weidongkl.github.io/img/weidongkl.png"><meta data-rh="true" property="og:url" content="http://weidongkl.github.io/docs/note/os/network/tc-network-guide"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="TC (Traffic Control) 网络模拟 | Weidong Note"><meta data-rh="true" name="description" content="1. 基础概念"><meta data-rh="true" property="og:description" content="1. 基础概念"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="http://weidongkl.github.io/docs/note/os/network/tc-network-guide"><link data-rh="true" rel="alternate" href="http://weidongkl.github.io/en/docs/note/os/network/tc-network-guide" hreflang="en"><link data-rh="true" rel="alternate" href="http://weidongkl.github.io/docs/note/os/network/tc-network-guide" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="http://weidongkl.github.io/docs/note/os/network/tc-network-guide" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"OS","item":"http://weidongkl.github.io/docs/category/os"},{"@type":"ListItem","position":2,"name":"网路","item":"http://weidongkl.github.io/docs/category/网路"},{"@type":"ListItem","position":3,"name":"TC (Traffic Control) 网络模拟","item":"http://weidongkl.github.io/docs/note/os/network/tc-network-guide"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Weidong Note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Weidong Note Atom Feed"><link rel="stylesheet" href="/assets/css/styles.2f4b7bdb.css">
<script src="/assets/js/runtime~main.e663b688.js" defer="defer"></script>
<script src="/assets/js/main.e85ad58d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="weidongkl" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="weidongkl" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">weidongkl</b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="搜索" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/os">笔记</a><a class="navbar__item navbar__link" href="/blog">博客</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/en/docs/note/os/network/tc-network-guide" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/docs/note/os/network/tc-network-guide" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li></ul></div><a class="navbar__item navbar__link" href="/about">关于我</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="fixedBanner_aqMt"></div><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/os">OS</a><button aria-label="折叠侧边栏分类 &#x27;OS&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/调试工具">调试工具</a><button aria-label="展开侧边栏分类 &#x27;调试工具&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/问题定位">问题定位</a><button aria-label="展开侧边栏分类 &#x27;问题定位&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/容器">容器</a><button aria-label="展开侧边栏分类 &#x27;容器&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/网路">网路</a><button aria-label="折叠侧边栏分类 &#x27;网路&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/note/os/network/ssh_tunnel">使用SSH 隧道连接网络</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/note/os/network/tc-network-guide">TC (Traffic Control) 网络模拟</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/note/os/chroot">chroot 用法</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/note/os/kernel/build_flag">kernel</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/note/os/zombie">僵尸进程</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/build">Build</a><button aria-label="展开侧边栏分类 &#x27;Build&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/design">Design</a><button aria-label="展开侧边栏分类 &#x27;Design&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/git">Git</a><button aria-label="展开侧边栏分类 &#x27;Git&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/web">web</a><button aria-label="展开侧边栏分类 &#x27;web&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/golang">Golang</a><button aria-label="展开侧边栏分类 &#x27;Golang&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/note/ide/vscode-terminal-file-dir">ide</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/os"><span>OS</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/网路"><span>网路</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">TC (Traffic Control) 网络模拟</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>TC (Traffic Control) 网络模拟</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-基础概念">1. 基础概念<a href="#1-基础概念" class="hash-link" aria-label="1. 基础概念的直接链接" title="1. 基础概念的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-什么是-tc">1.1. 什么是 TC<a href="#11-什么是-tc" class="hash-link" aria-label="1.1. 什么是 TC的直接链接" title="1.1. 什么是 TC的直接链接">​</a></h3>
<p>TC (Traffic Control) 是 Linux 内核提供的流量控制工具，可以模拟各种网络条件。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-基本命令结构">1.2. 基本命令结构<a href="#12-基本命令结构" class="hash-link" aria-label="1.2. 基本命令结构的直接链接" title="1.2. 基本命令结构的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 基本语法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc [add|change|replace|del] dev &lt;设备&gt; [root|parent &lt;句柄&gt;] [网络模拟参数]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看当前规则</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc show dev &lt;设备&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 删除所有规则</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc del dev &lt;设备&gt; root</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-网络延迟模拟">2. 网络延迟模拟<a href="#2-网络延迟模拟" class="hash-link" aria-label="2. 网络延迟模拟的直接链接" title="2. 网络延迟模拟的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-固定延迟">2.1. 固定延迟<a href="#21-固定延迟" class="hash-link" aria-label="2.1. 固定延迟的直接链接" title="2.1. 固定延迟的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 添加 100ms 固定延迟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root netem delay 100ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 修改延迟为 200ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc change dev eth0 root netem delay 200ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 替换现有规则</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc replace dev eth0 root netem delay 150ms</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-随机延迟波动">2.2. 随机延迟波动<a href="#22-随机延迟波动" class="hash-link" aria-label="2.2. 随机延迟波动的直接链接" title="2.2. 随机延迟波动的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 2.2.1. 100ms ± 20ms 随机波动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root netem delay 100ms 20ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 2.2.2. 100ms ± 50ms，延迟相关性 25%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root netem delay 100ms 50ms 25%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 0% 的延迟相关性，表示每个延迟都是随机生成，和上一个没有关系。默认是0%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 25% 前数据包延迟有25%的可能性跟随前一个数据包的延迟趋势</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-延迟分布模型">2.3. 延迟分布模型<a href="#23-延迟分布模型" class="hash-link" aria-label="2.3. 延迟分布模型的直接链接" title="2.3. 延迟分布模型的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 2.3.1. 正态分布延迟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root netem delay 100ms 30ms distribution normal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 2.3.2. 帕累托分布延迟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root netem delay 100ms 30ms distribution pareto</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-其他网络条件模拟">3. 其他网络条件模拟<a href="#3-其他网络条件模拟" class="hash-link" aria-label="3. 其他网络条件模拟的直接链接" title="3. 其他网络条件模拟的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-丢包模拟">3.1. 丢包模拟<a href="#31-丢包模拟" class="hash-link" aria-label="3.1. 丢包模拟的直接链接" title="3.1. 丢包模拟的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 3.1.1. 5% 丢包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root netem loss 5%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3.1.2. 5% 丢包，相关性 25%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root netem loss 5% 25%</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-带宽限制">3.2. 带宽限制<a href="#32-带宽限制" class="hash-link" aria-label="3.2. 带宽限制的直接链接" title="3.2. 带宽限制的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 3.2.1. 限制为 1Mbps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root tbf rate 1mbit burst 32kbit latency 400ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3.2.2. 使用 HTB 进行精细控制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root handle 1: htb default 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc class add dev eth0 parent 1: classid 1:1 htb rate 10mbit</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-数据包损坏和重复">3.3. 数据包损坏和重复<a href="#33-数据包损坏和重复" class="hash-link" aria-label="3.3. 数据包损坏和重复的直接链接" title="3.3. 数据包损坏和重复的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 3.3.1. 2% 的数据包损坏</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root netem corrupt 2%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3.3.2. 3% 的数据包重复</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root netem duplicate 3%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3.3.3. 5% 的数据包重排序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root netem delay 50ms reorder 10%</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-组合网络条件">4. 组合网络条件<a href="#4-组合网络条件" class="hash-link" aria-label="4. 组合网络条件的直接链接" title="4. 组合网络条件的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-复杂网络模拟">4.1. 复杂网络模拟<a href="#41-复杂网络模拟" class="hash-link" aria-label="4.1. 复杂网络模拟的直接链接" title="4.1. 复杂网络模拟的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 4.1.1. 延迟 + 丢包组合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root netem delay 100ms loss 3%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 4.1.2. 完整恶劣网络模拟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root netem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    delay 300ms 100ms 25% \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loss 15% 30% \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    duplicate 2% \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    corrupt 1% \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reorder 10% 50%</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-特定场景模拟">4.2. 特定场景模拟<a href="#42-特定场景模拟" class="hash-link" aria-label="4.2. 特定场景模拟的直接链接" title="4.2. 特定场景模拟的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 4.2.1. 移动网络模拟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root netem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    delay 100ms 50ms 25% \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loss 1% 30% \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    duplicate 0.5%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 4.2.2. 卫星链路模拟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root netem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    delay 500ms 100ms \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loss 0.5% \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    duplicate 0.1%</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-针对特定流量的控制">5. 针对特定流量的控制<a href="#5-针对特定流量的控制" class="hash-link" aria-label="5. 针对特定流量的控制的直接链接" title="5. 针对特定流量的控制的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="51-基于端口的控制">5.1. 基于端口的控制<a href="#51-基于端口的控制" class="hash-link" aria-label="5.1. 基于端口的控制的直接链接" title="5.1. 基于端口的控制的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 5.1.1. 创建分类队列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root handle 1: prio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 parent 1:1 handle 10: netem delay 100ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 parent 1:2 handle 20: netem delay 50ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 5.1.2. HTTP 流量高延迟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc filter add dev eth0 protocol ip parent 1: prio 1 u32 match ip dport 80 0xffff flowid 1:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 5.1.3. SSH 流量中等延迟  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc filter add dev eth0 protocol ip parent 1: prio 2 u32 match ip dport 22 0xffff flowid 1:2</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="52-基于-ip-的控制">5.2. 基于 IP 的控制<a href="#52-基于-ip-的控制" class="hash-link" aria-label="5.2. 基于 IP 的控制的直接链接" title="5.2. 基于 IP 的控制的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 5.2.1. 为特定目标 IP 添加延迟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc filter add dev eth0 protocol ip parent 1: prio 1 u32 match ip dst 192.168.1.100 flowid 1:1</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-延迟效果验证方法">6. 延迟效果验证方法<a href="#6-延迟效果验证方法" class="hash-link" aria-label="6. 延迟效果验证方法的直接链接" title="6. 延迟效果验证方法的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="61-基础-ping-测试">6.1. 基础 ping 测试<a href="#61-基础-ping-测试" class="hash-link" aria-label="6.1. 基础 ping 测试的直接链接" title="6.1. 基础 ping 测试的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 6.1.1. 基本延迟测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ping -c 10 google.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 6.1.2. 显示时间戳</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ping -D -c 10 8.8.8.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 6.1.3. 简化统计输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ping -c 20 -q 8.8.8.8</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="62-解析-ping-输出">6.2. 解析 ping 输出<a href="#62-解析-ping-输出" class="hash-link" aria-label="6.2. 解析 ping 输出的直接链接" title="6.2. 解析 ping 输出的直接链接">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">--- 8.8.8.8 ping statistics ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10 packets transmitted, 10 received, 0% packet loss, time 9014ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rtt min/avg/max/mdev = 98.123/102.456/105.789/2.123 ms</span><br></span></code></pre></div></div>
<ul>
<li><strong>min</strong>: 最小延迟</li>
<li><strong>avg</strong>: 平均延迟</li>
<li><strong>max</strong>: 最大延迟</li>
<li><strong>mdev</strong>: 延迟波动</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="63-路径分析工具">6.3. 路径分析工具<a href="#63-路径分析工具" class="hash-link" aria-label="6.3. 路径分析工具的直接链接" title="6.3. 路径分析工具的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 6.3.1. 显示路径每跳延迟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">traceroute www.baidu.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 6.3.2. 实时路径监控</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mtr google.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 6.3.3. 生成报告</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mtr -r -c 10 google.com</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-tcphttp-延迟测试">7. TCP/HTTP 延迟测试<a href="#7-tcphttp-延迟测试" class="hash-link" aria-label="7. TCP/HTTP 延迟测试的直接链接" title="7. TCP/HTTP 延迟测试的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="71-curl-详细时间分析">7.1. curl 详细时间分析<a href="#71-curl-详细时间分析" class="hash-link" aria-label="7.1. curl 详细时间分析的直接链接" title="7.1. curl 详细时间分析的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 7.1.1. 显示连接各阶段时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -w &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DNS解析: %{time_namelookup}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">连接建立: %{time_connect}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TLS握手: %{time_appconnect}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">传输开始: %{time_starttransfer}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总时间: %{time_total}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot; -o /dev/null -s https://www.baidu.com</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="72-使用时间模板文件">7.2. 使用时间模板文件<a href="#72-使用时间模板文件" class="hash-link" aria-label="7.2. 使用时间模板文件的直接链接" title="7.2. 使用时间模板文件的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 7.2.1. 创建时间格式文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; time_format.txt &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">时间统计:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DNS解析: %{time_namelookup} s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">连接建立: %{time_connect} s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TLS握手: %{time_appconnect} s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">首字节: %{time_starttransfer} s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总时间: %{time_total} s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 7.2.2. 使用格式文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -w &quot;@time_format.txt&quot; -o /dev/null -s https://google.com</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="8-专业性能测试">8. 专业性能测试<a href="#8-专业性能测试" class="hash-link" aria-label="8. 专业性能测试的直接链接" title="8. 专业性能测试的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="81-iperf3-测试">8.1. iperf3 测试<a href="#81-iperf3-测试" class="hash-link" aria-label="8.1. iperf3 测试的直接链接" title="8.1. iperf3 测试的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 8.1.1. 服务器端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iperf3 -s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 8.1.2. 客户端测试带宽和延迟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iperf3 -c server_ip -t 30 -i 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 8.1.3. UDP 测试（更准确反映延迟）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iperf3 -c server_ip -u -b 10M -t 30</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="82-实时监控命令">8.2. 实时监控命令<a href="#82-实时监控命令" class="hash-link" aria-label="8.2. 实时监控命令的直接链接" title="8.2. 实时监控命令的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 8.2.1. 查看 TC 规则状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc -s qdisc show dev eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 8.2.2. 实时监控队列统计</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">watch -n 1 &#x27;tc -s qdisc show dev eth0&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 8.2.3. 查看详细包统计</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc -s qdisc ls dev eth0</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="9-自动化测试脚本">9. 自动化测试脚本<a href="#9-自动化测试脚本" class="hash-link" aria-label="9. 自动化测试脚本的直接链接" title="9. 自动化测试脚本的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="91-完整的对比测试脚本">9.1. 完整的对比测试脚本<a href="#91-完整的对比测试脚本" class="hash-link" aria-label="9.1. 完整的对比测试脚本的直接链接" title="9.1. 完整的对比测试脚本的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TARGET=&quot;8.8.8.8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INTERFACE=&quot;eth0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TEST_DELAYS=(&quot;50ms&quot; &quot;100ms&quot; &quot;200ms&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;=== 网络延迟模拟测试 ===&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;目标主机: $TARGET&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;网络接口: $INTERFACE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 9.1.1. 基准测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;1. 基准测试（无延迟模拟）:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ping -c 5 -q $TARGET | grep rtt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for delay in &quot;${TEST_DELAYS[@]}&quot;; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;2. 设置 $delay 延迟:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tc qdisc add dev $INTERFACE root netem delay $delay 2&gt;/dev/null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 9.1.2. 测试当前延迟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;当前延迟效果:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ping -c 5 -q $TARGET | grep rtt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 9.1.3. 测试 TCP 连接延迟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;TCP 连接延迟:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    curl -w &quot;总时间: %{time_total}s\n&quot; -o /dev/null -s http://$TARGET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sleep 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 9.1.4. 清理规则</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tc qdisc del dev $INTERFACE root 2&gt;/dev/null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;=== 测试完成 ===&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="92-延迟波动验证脚本">9.2. 延迟波动验证脚本<a href="#92-延迟波动验证脚本" class="hash-link" aria-label="9.2. 延迟波动验证脚本的直接链接" title="9.2. 延迟波动验证脚本的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TARGET=&quot;8.8.8.8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INTERFACE=&quot;eth0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DURATION=30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;测试延迟波动效果...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;设置: 100ms ± 50ms 延迟波动&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev $INTERFACE root netem delay 100ms 50ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;开始收集延迟数据...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ping -c $DURATION $TARGET | grep &#x27;time=&#x27; | awk -F&#x27;[= ]&#x27; &#x27;{print $8}&#x27; &gt; latency_data.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;延迟统计:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">awk &#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    delays[NR] = $1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sum += $1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">END {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (NR &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        avg = sum / NR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        asort(delays)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mid = int(NR / 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (NR % 2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            median = delays[mid + 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            median = (delays[mid] + delays[mid + 1]) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print &quot;样本数: &quot; NR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print &quot;平均延迟: &quot; avg &quot; ms&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print &quot;中位数: &quot; median &quot; ms&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print &quot;最小延迟: &quot; delays[1] &quot; ms&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print &quot;最大延迟: &quot; delays[NR] &quot; ms&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print &quot;波动范围: &quot; (delays[NR] - delays[1]) &quot; ms&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}&#x27; latency_data.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 9.2.1. 清理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc del dev $INTERFACE root 2&gt;/dev/null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm latency_data.txt</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="10-高级监控和分析">10. 高级监控和分析<a href="#10-高级监控和分析" class="hash-link" aria-label="10. 高级监控和分析的直接链接" title="10. 高级监控和分析的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="101-实时延迟监控">10.1. 实时延迟监控<a href="#101-实时延迟监控" class="hash-link" aria-label="10.1. 实时延迟监控的直接链接" title="10.1. 实时延迟监控的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 10.1.1. 持续监控并记录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ping $TARGET | while read pong; do </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;$(date &#x27;+%H:%M:%S&#x27;): $pong&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 10.1.2. 提取延迟数值监控</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ping $TARGET | awk -F&#x27;[= ]&#x27; &#x27;/time=/ {print strftime(&quot;%H:%M:%S&quot;) &quot; - &quot; $(NF-1) &quot;ms&quot;}&#x27;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="102-tc-统计信息解读">10.2. TC 统计信息解读<a href="#102-tc-统计信息解读" class="hash-link" aria-label="10.2. TC 统计信息解读的直接链接" title="10.2. TC 统计信息解读的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 10.2.1. 查看详细统计</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc -s qdisc show dev eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 10.2.2. 输出示例解读:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qdisc netem 8001: root refcnt 2 limit 1000 delay 100.0ms  10.0ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Sent 123456 bytes 1000 pkt (dropped 50, overlimits 0 requeues 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 10.2.3. 关键指标:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># - Sent: 发送的数据量和包数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># - dropped: 丢包数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># - overlimits: 超过限制的包数</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="11-故障排除和恢复">11. 故障排除和恢复<a href="#11-故障排除和恢复" class="hash-link" aria-label="11. 故障排除和恢复的直接链接" title="11. 故障排除和恢复的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="111-常见问题处理">11.1. 常见问题处理<a href="#111-常见问题处理" class="hash-link" aria-label="11.1. 常见问题处理的直接链接" title="11.1. 常见问题处理的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 11.1.1. 强制删除所有规则</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc del dev eth0 root 2&gt;/dev/null || true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 11.1.2. 检查设备状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip link show dev eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 11.1.3. 验证规则是否生效</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc show dev eth0</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="112-安全恢复脚本">11.2. 安全恢复脚本<a href="#112-安全恢复脚本" class="hash-link" aria-label="11.2. 安全恢复脚本的直接链接" title="11.2. 安全恢复脚本的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INTERFACE=&quot;eth0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;正在恢复网络设置...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc del dev $INTERFACE root 2&gt;/dev/null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 11.2.1. 验证恢复</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;当前网络规则:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc show dev $INTERFACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;网络延迟测试:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ping -c 3 -q 8.8.8.8 | grep rtt</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="12-最佳实践建议">12. 最佳实践建议<a href="#12-最佳实践建议" class="hash-link" aria-label="12. 最佳实践建议的直接链接" title="12. 最佳实践建议的直接链接">​</a></h2>
<p><strong>测试前准备</strong></p>
<ul>
<li>
<p><strong>测试前备份</strong>: 记录原始网络设置</p>
</li>
<li>
<p><strong>环境检查</strong>: 确认网络接口和设备状态</p>
</li>
</ul>
<p><strong>测试执行</strong></p>
<ul>
<li><strong>逐步验证</strong>: 从简单延迟开始，逐步增加复杂度</li>
<li><strong>多工具验证</strong>: 使用 ping、curl、traceroute 等多种工具交叉验证</li>
</ul>
<p><strong>生产环境注意事项</strong></p>
<ul>
<li><strong>生产环境谨慎</strong>: 在生产环境测试时设置超时和自动恢复</li>
<li><strong>文档记录</strong>: 记录测试参数和结果，便于问题排查</li>
</ul>
<p><strong>性能监控</strong></p>
<ul>
<li><strong>实时监控</strong>: 使用 watch 命令实时监控 TC 统计信息</li>
<li><strong>数据记录</strong>: 保存测试数据用于后续分析</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/weidongkl/weidongkl.github.io/tree/master/docs/note/os/network/tc-network-guide.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最后<!-- -->由 <b>weidongkl</b> <!-- -->于 <b><time datetime="2025-11-01T13:34:02.000Z" itemprop="dateModified">2025年11月1日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/note/os/network/ssh_tunnel"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">使用SSH 隧道连接网络</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/note/os/chroot"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">chroot 用法</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-基础概念" class="table-of-contents__link toc-highlight">1. 基础概念</a><ul><li><a href="#11-什么是-tc" class="table-of-contents__link toc-highlight">1.1. 什么是 TC</a></li><li><a href="#12-基本命令结构" class="table-of-contents__link toc-highlight">1.2. 基本命令结构</a></li></ul></li><li><a href="#2-网络延迟模拟" class="table-of-contents__link toc-highlight">2. 网络延迟模拟</a><ul><li><a href="#21-固定延迟" class="table-of-contents__link toc-highlight">2.1. 固定延迟</a></li><li><a href="#22-随机延迟波动" class="table-of-contents__link toc-highlight">2.2. 随机延迟波动</a></li><li><a href="#23-延迟分布模型" class="table-of-contents__link toc-highlight">2.3. 延迟分布模型</a></li></ul></li><li><a href="#3-其他网络条件模拟" class="table-of-contents__link toc-highlight">3. 其他网络条件模拟</a><ul><li><a href="#31-丢包模拟" class="table-of-contents__link toc-highlight">3.1. 丢包模拟</a></li><li><a href="#32-带宽限制" class="table-of-contents__link toc-highlight">3.2. 带宽限制</a></li><li><a href="#33-数据包损坏和重复" class="table-of-contents__link toc-highlight">3.3. 数据包损坏和重复</a></li></ul></li><li><a href="#4-组合网络条件" class="table-of-contents__link toc-highlight">4. 组合网络条件</a><ul><li><a href="#41-复杂网络模拟" class="table-of-contents__link toc-highlight">4.1. 复杂网络模拟</a></li><li><a href="#42-特定场景模拟" class="table-of-contents__link toc-highlight">4.2. 特定场景模拟</a></li></ul></li><li><a href="#5-针对特定流量的控制" class="table-of-contents__link toc-highlight">5. 针对特定流量的控制</a><ul><li><a href="#51-基于端口的控制" class="table-of-contents__link toc-highlight">5.1. 基于端口的控制</a></li><li><a href="#52-基于-ip-的控制" class="table-of-contents__link toc-highlight">5.2. 基于 IP 的控制</a></li></ul></li><li><a href="#6-延迟效果验证方法" class="table-of-contents__link toc-highlight">6. 延迟效果验证方法</a><ul><li><a href="#61-基础-ping-测试" class="table-of-contents__link toc-highlight">6.1. 基础 ping 测试</a></li><li><a href="#62-解析-ping-输出" class="table-of-contents__link toc-highlight">6.2. 解析 ping 输出</a></li><li><a href="#63-路径分析工具" class="table-of-contents__link toc-highlight">6.3. 路径分析工具</a></li></ul></li><li><a href="#7-tcphttp-延迟测试" class="table-of-contents__link toc-highlight">7. TCP/HTTP 延迟测试</a><ul><li><a href="#71-curl-详细时间分析" class="table-of-contents__link toc-highlight">7.1. curl 详细时间分析</a></li><li><a href="#72-使用时间模板文件" class="table-of-contents__link toc-highlight">7.2. 使用时间模板文件</a></li></ul></li><li><a href="#8-专业性能测试" class="table-of-contents__link toc-highlight">8. 专业性能测试</a><ul><li><a href="#81-iperf3-测试" class="table-of-contents__link toc-highlight">8.1. iperf3 测试</a></li><li><a href="#82-实时监控命令" class="table-of-contents__link toc-highlight">8.2. 实时监控命令</a></li></ul></li><li><a href="#9-自动化测试脚本" class="table-of-contents__link toc-highlight">9. 自动化测试脚本</a><ul><li><a href="#91-完整的对比测试脚本" class="table-of-contents__link toc-highlight">9.1. 完整的对比测试脚本</a></li><li><a href="#92-延迟波动验证脚本" class="table-of-contents__link toc-highlight">9.2. 延迟波动验证脚本</a></li></ul></li><li><a href="#10-高级监控和分析" class="table-of-contents__link toc-highlight">10. 高级监控和分析</a><ul><li><a href="#101-实时延迟监控" class="table-of-contents__link toc-highlight">10.1. 实时延迟监控</a></li><li><a href="#102-tc-统计信息解读" class="table-of-contents__link toc-highlight">10.2. TC 统计信息解读</a></li></ul></li><li><a href="#11-故障排除和恢复" class="table-of-contents__link toc-highlight">11. 故障排除和恢复</a><ul><li><a href="#111-常见问题处理" class="table-of-contents__link toc-highlight">11.1. 常见问题处理</a></li><li><a href="#112-安全恢复脚本" class="table-of-contents__link toc-highlight">11.2. 安全恢复脚本</a></li></ul></li><li><a href="#12-最佳实践建议" class="table-of-contents__link toc-highlight">12. 最佳实践建议</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 weidongkl, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>