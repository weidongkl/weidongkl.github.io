"use strict";(self.webpackChunkweidongkl_github_io=self.webpackChunkweidongkl_github_io||[]).push([[1431,3209],{1649:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>g});const o=JSON.parse('{"id":"note/golang/design/microkernel/microkernel7","title":"microkernel \u8bbe\u8ba17","description":"1. \u76ee\u6807","source":"@site/docs/note/golang/design/microkernel/microkernel7.md","sourceDirName":"note/golang/design/microkernel","slug":"/note/golang/design/microkernel/microkernel7","permalink":"/en/docs/note/golang/design/microkernel/microkernel7","draft":false,"unlisted":false,"editUrl":"https://github.com/weidongkl/weidongkl.github.io/tree/master/docs/note/golang/design/microkernel/microkernel7.md","tags":[],"version":"current","lastUpdatedBy":"weidongkl","lastUpdatedAt":1767705041000,"sidebarPosition":7,"frontMatter":{"sidebar_position":7},"sidebar":"note","previous":{"title":"microkernel \u8bbe\u8ba16","permalink":"/en/docs/note/golang/design/microkernel/microkernel6"},"next":{"title":"microkernel \u8bbe\u8ba18","permalink":"/en/docs/note/golang/design/microkernel/microkernel8"}}');var t=r(74848),l=r(28453);const i={sidebar_position:7},s="microkernel \u8bbe\u8ba17",c={},g=[{value:"1. \u76ee\u6807",id:"1-\u76ee\u6807",level:2},{value:"2. \u4ee3\u7801\u6539\u52a8",id:"2-\u4ee3\u7801\u6539\u52a8",level:2},{value:"2.1 Kernel\uff08\u6838\u5fc3\uff09",id:"21-kernel\u6838\u5fc3",level:3},{value:"2.2 \u65e5\u5fd7\u670d\u52a1",id:"22-\u65e5\u5fd7\u670d\u52a1",level:3},{value:"2.3 main",id:"23-main",level:3},{value:"2.4 \u8fd0\u884c\u7ed3\u679c",id:"24-\u8fd0\u884c\u7ed3\u679c",level:3}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"microkernel-\u8bbe\u8ba17",children:"microkernel \u8bbe\u8ba17"})}),"\n",(0,t.jsx)(n.h2,{id:"1-\u76ee\u6807",children:"1. \u76ee\u6807"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u652f\u6301\u670d\u52a1\u70ed\u66f4\u65b0"}),"\n",(0,t.jsxs)(n.li,{children:["\u6240\u6709\u670d\u52a1\u548c\u5185\u6838\u901a\u8fc7\u7edf\u4e00\u63a5\u53e3\u6253\u5370\u65e5\u5fd7","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u65f6\u95f4\u6233\u3001\u670d\u52a1\u540d\u3001\u7ea7\u522b\uff08INFO/WARN/ERROR\uff09"}),"\n",(0,t.jsx)(n.li,{children:"\u52a8\u6001\u63a7\u5236\u65e5\u5fd7\u7ea7\u522b"}),"\n",(0,t.jsxs)(n.li,{children:["\u8f93\u51fa\u5230 ",(0,t.jsx)(n.code,{children:"stdout"}),"\u3001\u6587\u4ef6\u3001\u8fdc\u7a0b\u670d\u52a1\u7b49"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:"xxx"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"2-\u4ee3\u7801\u6539\u52a8",children:"2. \u4ee3\u7801\u6539\u52a8"}),"\n",(0,t.jsx)(n.h3,{id:"21-kernel\u6838\u5fc3",children:"2.1 Kernel\uff08\u6838\u5fc3\uff09"}),"\n",(0,t.jsxs)(n.p,{children:["\u65b0\u589e",(0,t.jsx)(n.code,{children:"ReplaceService"})," \u7528\u4e8e\u70ed\u66ff\u6362\u670d\u52a1"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'// kernel/kernel.go\nfunc (k *MicroKernel) ReplaceService(newSvc Service) error {\n    k.mu.Lock()\n    defer k.mu.Unlock()\n\n    name := newSvc.Name()\n    oldMeta, exists := k.services[name]\n\n    if exists && oldMeta.state == Running {\n        // \u505c\u6b62\u65e7\u670d\u52a1\n        oldMeta.svc.Stop()\n        fmt.Printf("Stopped old version of %s\\n", name)\n    }\n\n    // \u66ff\u6362\u670d\u52a1\u5b9e\u73b0\uff0c\u91cd\u5efa\u5143\u4fe1\u606f\n    k.services[name] = &serviceMeta{\n        svc:  newSvc,\n        deps: newSvc.Dependencies(),\n        state: Created,\n    }\n\n    // \u91cd\u542f\u670d\u52a1\uff08\u5982\u65e7\u670d\u52a1\u5728\u8fd0\u884c\uff09\n    if exists && oldMeta.state == Running {\n        newSvc.Start()\n        k.services[name].state = Running\n        fmt.Printf("Started new version of %s\\n", name)\n    } else {\n        fmt.Printf("Registered new version of %s (not started)\\n", name)\n    }\n\n    return nil\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u6ce8\u518cRegister\u589e\u52a0deps"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'// kernel/kernel.go\n\n// Register \u6ce8\u518c\u670d\u52a1\n// \u91cd\u547d\u540d RegisterService \u4e3a Register\nfunc (k *MicroKernel) Register(svc Service) error {\n\tk.mu.Lock()\n\tdefer k.mu.Unlock()\n\n\tname := svc.Name()\n\tif _, ok := k.services[name]; ok {\n\t\treturn errors.New("service already registered")\n\t}\n\tk.services[name] = &serviceMeta{\n\t\tsvc:   svc,\n\t\tstate: Created,\n\t\tdeps:  svc.Dependencies(),\n\t}\n\tfmt.Println("Registered:", svc.Name())\n\treturn nil\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u542f\u52a8\u670d\u52a1\u548c\u505c\u6b62\u670d\u52a1\u589e\u52a0\u62d3\u6251\u6392\u5e8f"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'// kernel/kernel.go\nfunc (k *MicroKernel) topoSort() ([]string, error) {\n    k.mu.RLock()\n    defer k.mu.RUnlock()\n\n    visited := make(map[string]bool)\n    temp := make(map[string]bool)\n    result := []string{}\n    var visit func(string) error\n\n    visit = func(name string) error {\n        if temp[name] {\n            return fmt.Errorf("circular dependency at %s", name)\n        }\n        if visited[name] {\n            return nil\n        }\n        temp[name] = true\n        meta, ok := k.services[name]\n        if !ok {\n            return fmt.Errorf("service %s not registered", name)\n        }\n        for _, dep := range meta.deps {\n            if err := visit(dep); err != nil {\n                return err\n            }\n        }\n        visited[name] = true\n        temp[name] = false\n        result = append(result, name)\n        return nil\n    }\n\n    for name := range k.services {\n        if !visited[name] {\n            if err := visit(name); err != nil {\n                return nil, err\n            }\n        }\n    }\n\n    return result, nil\n}\n\nfunc (k *MicroKernel) StartAll() error {\n    sorted, err := k.topoSort()\n    // ...\n    for _, name := range sorted {\n        if err := k.StartService(name); err != nil {\n            // ...\n        }\n    }\n    return nil\n}\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"22-\u65e5\u5fd7\u670d\u52a1",children:"2.2 \u65e5\u5fd7\u670d\u52a1"}),"\n",(0,t.jsx)(n.p,{children:"\u65e5\u5fd7\u670d\u52a1\u8bbe\u8ba1"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type LogLevel int\n\nconst (\n    INFO LogLevel = iota\n    WARN\n    ERROR\n)\n\ntype Logger struct {\n    mu      sync.Mutex\n    level   LogLevel\n    service string\n    out     io.Writer\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u65b9\u6cd5\u5b9e\u73b0"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'func NewLogger(service string, level LogLevel, out io.Writer) *Logger {\n    return &Logger{\n        service: service,\n        level:   level,\n        out:     out,\n    }\n}\n\nfunc (l *Logger) logf(level LogLevel, format string, args ...any) {\n    if level < l.level {\n        return\n    }\n    l.mu.Lock()\n    defer l.mu.Unlock()\n    levelStr := [...]string{"INFO", "WARN", "ERROR"}[level]\n    msg := fmt.Sprintf(format, args...)\n    ts := time.Now().Format("2006-01-02 15:04:05.000")\n    fmt.Fprintf(l.out, "[%s] [%s] [%s] %s\\n", ts, levelStr, l.service, msg)\n}\n\nfunc (l *Logger) Infof(format string, args ...any)  { l.logf(INFO, format, args...) }\nfunc (l *Logger) Warnf(format string, args ...any)  { l.logf(WARN, format, args...) }\nfunc (l *Logger) Errorf(format string, args ...any) { l.logf(ERROR, format, args...) }\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u670d\u52a1\u4e2d\u4f7f\u7528"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type EchoServiceV3 struct {\n    log *Logger\n}\n\nfunc NewEchoServiceV3() *EchoServiceV3 {\n    return &EchoServiceV3{\n        log: NewLogger("echo", INFO, os.Stdout),\n    }\n}\n\n//...\nfunc (e *EchoServiceV3) Start() {\n    e.log.Infof("started")\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"23-main",children:"2.3 main"}),"\n",(0,t.jsx)(n.p,{children:"\u70ed\u66ff\u6362\u670d\u52a1"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'// 7. \u70ed\u66ff\u6362\u670d\u52a1\n\t// \u70ed\u66f4\u65b0\u4e3a V2\n\t_ = microKernel.ReplaceService(service.NewEchoServiceV2(microKernel))\n\n\t// \u6d4b\u8bd5 V2 \u884c\u4e3a\n\treplyCh2 := make(chan microkernel.Reply, 1)\n\tmicroKernel.Push(microkernel.Event{\n\t\tFrom:      "main",\n\t\tType:      "log",\n\t\tContent:   "log",\n\t\tReplyCh:   replyCh2,\n\t\tTimeoutMs: 1000,\n\t})\n\tfmt.Println("v2 reply:", <-replyCh2)\n\n'})}),"\n",(0,t.jsx)(n.h3,{id:"24-\u8fd0\u884c\u7ed3\u679c",children:"2.4 \u8fd0\u884c\u7ed3\u679c"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"Registered: logger\nRegistered: echo\nStarting all services...\nServices: [echo logger]\n[echo] starting...\nStarted: echo\n[logger] starting...\nStarted: logger\n[logger] LOG: Hello, Microkernel!\n[MicroKernel] Event from logger: - Hello, Microkernel!\n[logger] got reply from kernel: Handled by kernel\n[logger] LOG: Hello, Echo!\n[MicroKernel] Event from logger: - Hello, Echo!\n[logger] got reply from kernel: echo service handled\n[MicroKernel] Send Event to unknown: Hello, Log!\n{404 Not found service }\n[echo] stopping...\nStopped old version of echo\n[2025-04-23 21:46:11.935] [INFO] [echo] [echov2] starting...\n\nStarted new version of echo\n[MicroKernel] Event from main: - log\nv2 reply: {0 Handled by kernel ok}\nStopping all services...\n[logger] stopping...\nStopped: logger\n[echov2] stopping...\n[log] stopping\nStopped: echo\nRegistered: logger\nRegistered: echo\nStarting all services...\nServices: [echo logger]\n[echo] starting...\nStarted: echo\n[logger] starting...\nStarted: logger\n[logger] LOG: Hello, Microkernel!\n[MicroKernel] Event from logger: - Hello, Microkernel!\n[logger] got reply from kernel: Handled by kernel\n[logger] LOG: Hello, Echo!\n[MicroKernel] Event from logger: - Hello, Echo!\n[logger] got reply from kernel: echo service handled\n[MicroKernel] Send Event to unknown: Hello, Log!\n{404 Not found service }\nStopping all services...\n[logger] stopping...\nStopped: logger\n[echo] stopping...\nStopped: echo\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u67e5\u770b",(0,t.jsx)(n.a,{href:"https://gitee.com/weidongkl/weidongkl.github.io/blob/master/docs/note/golang/design/microkernel/microkernel7",children:"\u5b8c\u6574\u4ee3\u7801"})]})]})}function d(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>s});var o=r(96540);const t={},l=o.createContext(t);function i(e){const n=o.useContext(l);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),o.createElement(l.Provider,{value:n},e.children)}}}]);