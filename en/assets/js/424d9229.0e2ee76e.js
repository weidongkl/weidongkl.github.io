"use strict";(self.webpackChunkweidongkl_github_io=self.webpackChunkweidongkl_github_io||[]).push([[6246,8851],{12528:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>g,frontMatter:()=>i,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"note/golang/design/microkernel/microkernel4","title":"microkernel \u8bbe\u8ba14","description":"1. \u76ee\u6807","source":"@site/docs/note/golang/design/microkernel/microkernel4.md","sourceDirName":"note/golang/design/microkernel","slug":"/note/golang/design/microkernel/microkernel4","permalink":"/en/docs/note/golang/design/microkernel/microkernel4","draft":false,"unlisted":false,"editUrl":"https://github.com/weidongkl/weidongkl.github.io/tree/master/docs/note/golang/design/microkernel/microkernel4.md","tags":[],"version":"current","lastUpdatedBy":"weidongkl","lastUpdatedAt":1763457434000,"sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"note","previous":{"title":"microkernel \u8bbe\u8ba13","permalink":"/en/docs/note/golang/design/microkernel/microkernel3"},"next":{"title":"microkernel \u8bbe\u8ba15","permalink":"/en/docs/note/golang/design/microkernel/microkernel5"}}');var l=n(74848),o=n(28453);const i={sidebar_position:4},s="microkernel \u8bbe\u8ba14",c={},a=[{value:"1. \u76ee\u6807",id:"1-\u76ee\u6807",level:2},{value:"2. \u4ee3\u7801\u6539\u52a8",id:"2-\u4ee3\u7801\u6539\u52a8",level:2},{value:"2.1 Kernel\uff08\u6838\u5fc3\uff09",id:"21-kernel\u6838\u5fc3",level:3},{value:"2.2 LogService",id:"22-logservice",level:3},{value:"2.3 \u589e\u52a0\u53e6\u4e00\u4e2a\u7c7b\u4f3c\u7684EchoService",id:"23-\u589e\u52a0\u53e6\u4e00\u4e2a\u7c7b\u4f3c\u7684echoservice",level:3},{value:"2.4 \u8fd0\u884c\u7ed3\u679c",id:"24-\u8fd0\u884c\u7ed3\u679c",level:3}];function d(e){const t={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(t.header,{children:(0,l.jsx)(t.h1,{id:"microkernel-\u8bbe\u8ba14",children:"microkernel \u8bbe\u8ba14"})}),"\n",(0,l.jsx)(t.h2,{id:"1-\u76ee\u6807",children:"1. \u76ee\u6807"}),"\n",(0,l.jsxs)(t.ul,{children:["\n",(0,l.jsx)(t.li,{children:(0,l.jsx)(t.strong,{children:"\u670d\u52a1\u95f4\u901a\u4fe1\uff08\u901a\u8fc7\u5185\u6838\u8f6c\u53d1\uff09"})}),"\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.strong,{children:"\u6807\u51c6\u5316\u6d88\u606f\u534f\u8bae\u7ed3\u6784"}),(0,l.jsx)(t.br,{}),"\n","\u652f\u6301\u72b6\u6001\u7801\u3001\u9519\u8bef\u3001\u6570\u636e\u8d1f\u8f7d\u3002"]}),"\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.strong,{children:"\u5f02\u6b65+\u8d85\u65f6\u673a\u5236"}),(0,l.jsx)(t.br,{}),"\n","\u670d\u52a1\u53d1\u51fa\u8bf7\u6c42\u65f6\u53ef\u4ee5\u8bbe\u7f6e\u8d85\u65f6\u65f6\u95f4\uff0c\u907f\u514d\u957f\u671f\u963b\u585e\u3002"]}),"\n"]}),"\n",(0,l.jsx)(t.h2,{id:"2-\u4ee3\u7801\u6539\u52a8",children:"2. \u4ee3\u7801\u6539\u52a8"}),"\n",(0,l.jsx)(t.h3,{id:"21-kernel\u6838\u5fc3",children:"2.1 Kernel\uff08\u6838\u5fc3\uff09"}),"\n",(0,l.jsx)(t.p,{children:"\u5b9a\u4e49\u6807\u51c6\u6d88\u606f\u683c\u5f0f"}),"\n",(0,l.jsxs)(t.ul,{children:["\n",(0,l.jsx)(t.li,{children:"Reply \u5305\u542bcode/message/Data"}),"\n",(0,l.jsx)(t.li,{children:"Event ReplyCh \u4f7f\u7528\u6807\u51c6\u683c\u5f0f\u7684Reply"}),"\n"]}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-go",children:"// kernel/kernel.go\n// Reply \u5b9a\u4e49\u5185\u6838\u4e8b\u4ef6\u56de\u590d\ntype Reply struct {\n\tCode    int    // 0 \u8868\u793a\u6210\u529f\uff0c\u975e0\u8868\u793a\u9519\u8bef\u7801\n\tMessage string // \u63cf\u8ff0\u4fe1\u606f\n\tData    string // \u53ef\u9009\u8d1f\u8f7d\n}\n// Event \u5b9a\u4e49\u5185\u6838\u4e8b\u4ef6\uff08\u7528\u4e8e\u670d\u52a1\u95f4\u901a\u4fe1\uff09\ntype Event struct {\n\tTo      string\n\tFrom    string\n\tType    string\n\tContent string\n\t// \u589e\u52a0\u54cd\u5e94\u901a\u9053,\u4f7f\u7528 chan Reply\uff0c\u63d0\u9ad8\u56de\u590d\u7684\u7075\u6d3b\u6027\n\tReplyCh chan Reply\n\t// \u53ef\u9009\uff1a\u8d85\u65f6\u65f6\u95f4\n\tTimeoutMs int\n}\n"})}),"\n",(0,l.jsx)(t.p,{children:"\u670d\u52a1\u6539\u9020"}),"\n",(0,l.jsxs)(t.ul,{children:["\n",(0,l.jsx)(t.li,{children:"handle \u4ece\u5904\u7406\u5b57\u7b26\u4e32\u4fee\u6539\u4e3a\u5904\u7406\u4e8b\u4ef6\uff0c\u8fd4\u56de\u6807\u51c6Reply"}),"\n"]}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-go",children:"// kernel/kernel.go\n// Service \u5b9a\u4e49\u5fae\u5185\u6838\u7684\u670d\u52a1\u63a5\u53e3\n// \u4f7f\u7528\u63a5\u53e3\u5b9a\u4e49\u4ee3\u66ff\u56fa\u5b9a\u7684struct,\u4f4e\u8026\u5408\u8bbe\u8ba1\u3002\ntype Service interface {\n\tStart() error\n\tStop() error\n\tName() string\n\tHandle(Event) Reply\n}\n"})}),"\n",(0,l.jsx)(t.p,{children:"Listen \u8def\u7531\u548c\u4e8b\u4ef6\u603b\u7ebf\u8bbe\u8ba1"}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-go",children:'// Listen \u4e8b\u4ef6\u5faa\u73af\uff08\u5904\u7406\u670d\u52a1\u95f4\u901a\u4fe1\uff09\n// \u76d1\u542c\u4e8b\u4ef6\uff0c\u5904\u7406\u670d\u52a1\u95f4\u901a\u4fe1\n// \u91cd\u547d\u540d EventLoop \u4e3a Listen\nfunc (k *Kernel) Listen(ctx context.Context) {\n\tfor {\n\t\tselect {\n\t\tcase <-ctx.Done():\n\t\t\treturn\n\t\tcase evt := <-k.eventCh:\n\t\t\tfmt.Printf("[Kernel] Event from %s: - %s\\n", evt.From, evt.Content)\n\t\t\t// \u53d1\u9001\u7ed9 Kernel \u81ea\u5df1\n\t\t\tif evt.To == "" {\n\t\t\t\tif evt.ReplyCh != nil {\n\t\t\t\t\tevt.ReplyCh <- Reply{Code: 0, Message: "Handled by kernel", Data: "ok"}\n\t\t\t\t}\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\t// \u8def\u7531\u5230\u76ee\u6807\u670d\u52a1\n\t\t\tk.mu.RLock()\n\t\t\tsvc, ok := k.services[evt.To]\n\t\t\tk.mu.RUnlock()\n\n\t\t\tif !ok {\n\t\t\t\tif evt.ReplyCh != nil {\n\t\t\t\t\tevt.ReplyCh <- Reply{Code: 404, Message: "Service not found", Data: ""}\n\t\t\t\t}\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\t// \u8c03\u7528\u76ee\u6807\u670d\u52a1\u5904\u7406\uff0c\u5e76\u8fd4\u56de\n\t\t\tgo func(s Service, m Event) {\n\t\t\t\tresult := s.Handle(m)\n\t\t\t\tif m.ReplyCh != nil {\n\t\t\t\t\tselect {\n\t\t\t\t\tcase m.ReplyCh <- result:\n\t\t\t\t\tcase <-time.After(time.Duration(m.TimeoutMs) * time.Millisecond):\n\t\t\t\t\t\tm.ReplyCh <- Reply{Code: 408, Message: "timeout", Data: ""}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}(svc, evt)\n\t\t}\n\t}\n}\n'})}),"\n",(0,l.jsx)(t.hr,{}),"\n",(0,l.jsx)(t.h3,{id:"22-logservice",children:"2.2 LogService"}),"\n",(0,l.jsx)(t.p,{children:"\u6839\u636ecount\u968f\u673a\u5206\u53d1\uff08Push \u6307\u5b9a\u4e86\u53d1\u9001\u4f4d\u7f6e\uff09"}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-go",children:'func (l *LogService) run() {\n\tvar count = 1\n\tfor {\n\t\tcount++\n\t\tselect {\n\t\tcase <-l.stopCh:\n\t\t\treturn\n\t\tcase log := <-l.logCh:\n\t\t\tfmt.Printf("[%s] LOG: %s\\n", l.name, log)\n\t\t\t// \u6a21\u62df\u53d1\u9001\u4e8b\u4ef6\u5230\u5185\u6838\n\t\t\treplyCh := make(chan kernel.Reply, 1)\n\t\t\tif count%2 == 0 {\n\t\t\t\tl.kernel.Push(kernel.Event{\n\t\t\t\t\tFrom:      l.name,\n\t\t\t\t\tType:      "log",\n\t\t\t\t\tContent:   log,\n\t\t\t\t\tReplyCh:   replyCh,\n\t\t\t\t\tTimeoutMs: 1000,\n\t\t\t\t})\n\t\t\t} else {\n\t\t\t\tl.kernel.Push(kernel.Event{\n\t\t\t\t\tFrom:      l.name,\n\t\t\t\t\tType:      "log",\n\t\t\t\t\tTo:        "echo",\n\t\t\t\t\tContent:   log,\n\t\t\t\t\tReplyCh:   replyCh,\n\t\t\t\t\tTimeoutMs: 1000,\n\t\t\t\t})\n\t\t\t}\n\t\t\t// \u7b49\u5f85\u5185\u6838\u56de\u5e94\n\t\t\treply := <-replyCh\n\t\t\tfmt.Printf("[%s] got reply from kernel: %s\\n", l.Name(), reply.Message)\n\t\t}\n\t}\n}\n'})}),"\n",(0,l.jsx)(t.hr,{}),"\n",(0,l.jsx)(t.h3,{id:"23-\u589e\u52a0\u53e6\u4e00\u4e2a\u7c7b\u4f3c\u7684echoservice",children:"2.3 \u589e\u52a0\u53e6\u4e00\u4e2a\u7c7b\u4f3c\u7684EchoService"}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-go",children:'func (e *EchoService) Handle(evt kernel.Event) kernel.Reply {\n\treturn kernel.Reply{Code: 0, Message: "echo service handled", Data: fmt.Sprintf("from %s: %s", evt.From, evt.Content)}\n}\n'})}),"\n",(0,l.jsx)(t.h3,{id:"24-\u8fd0\u884c\u7ed3\u679c",children:"2.4 \u8fd0\u884c\u7ed3\u679c"}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-bash",children:"Registered: logger\n# \u6ce8\u518c\u53e6\u4e00\u4e2a\u670d\u52a1\nRegistered: echo\n[logger] starting...\n[echo] starting...\n[logger] LOG: Hello, Microkernel!\n[Kernel] Event from logger: - Hello, Microkernel!\n[logger] got reply from kernel: Handled by kernel\n[logger] LOG: Hello, Echo!\n[Kernel] Event from logger: - Hello, Echo!\n# \u8f6c\u53d1\u5230echoService \u5904\u7406\n[logger] got reply from kernel: echo service handled\n[Kernel] Send Event to logger: Hello, Log!\n[logger] LOG handle kernel event: Hello, Log!\n[logger] stopping...\n[echo] stopping...\n\n"})}),"\n",(0,l.jsxs)(t.p,{children:["\u67e5\u770b",(0,l.jsx)(t.a,{href:"https://gitee.com/weidongkl/weidongkl.github.io/blob/master/docs/note/golang/design/microkernel/microkernel4",children:"\u5b8c\u6574\u4ee3\u7801"})]})]})}function g(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,l.jsx)(t,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>s});var r=n(96540);const l={},o=r.createContext(l);function i(e){const t=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:i(e.components),r.createElement(o.Provider,{value:t},e.children)}}}]);