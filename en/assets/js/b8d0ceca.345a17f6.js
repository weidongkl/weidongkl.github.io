"use strict";(self.webpackChunkweidongkl_github_io=self.webpackChunkweidongkl_github_io||[]).push([[4261,7285],{1915:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>g,frontMatter:()=>l,metadata:()=>t,toc:()=>a});const t=JSON.parse('{"id":"note/golang/design/microkernel/microkernel6","title":"microkernel \u8bbe\u8ba16","description":"1. \u76ee\u6807","source":"@site/docs/note/golang/design/microkernel/microkernel6.md","sourceDirName":"note/golang/design/microkernel","slug":"/note/golang/design/microkernel/microkernel6","permalink":"/en/docs/note/golang/design/microkernel/microkernel6","draft":false,"unlisted":false,"editUrl":"https://github.com/weidongkl/weidongkl.github.io/tree/master/docs/note/golang/design/microkernel/microkernel6.md","tags":[],"version":"current","lastUpdatedBy":"weidongkl","lastUpdatedAt":1767519914000,"sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"note","previous":{"title":"microkernel \u8bbe\u8ba15","permalink":"/en/docs/note/golang/design/microkernel/microkernel5"},"next":{"title":"microkernel \u8bbe\u8ba17","permalink":"/en/docs/note/golang/design/microkernel/microkernel7"}}');var i=r(74848),o=r(28453);const l={sidebar_position:6},s="microkernel \u8bbe\u8ba16",c={},a=[{value:"1. \u76ee\u6807",id:"1-\u76ee\u6807",level:2},{value:"2. \u4ee3\u7801\u6539\u52a8",id:"2-\u4ee3\u7801\u6539\u52a8",level:2},{value:"2.1 Kernel\uff08\u6838\u5fc3\uff09",id:"21-kernel\u6838\u5fc3",level:3},{value:"2.2 \u670d\u52a1",id:"22-\u670d\u52a1",level:3},{value:"2.3 \u8fd0\u884c\u7ed3\u679c",id:"23-\u8fd0\u884c\u7ed3\u679c",level:3}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"microkernel-\u8bbe\u8ba16",children:"microkernel \u8bbe\u8ba16"})}),"\n",(0,i.jsx)(n.h2,{id:"1-\u76ee\u6807",children:"1. \u76ee\u6807"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u652f\u6301\u670d\u52a1\u4f9d\u8d56\u5173\u7cfb\u7ba1\u7406"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"2-\u4ee3\u7801\u6539\u52a8",children:"2. \u4ee3\u7801\u6539\u52a8"}),"\n",(0,i.jsx)(n.h3,{id:"21-kernel\u6838\u5fc3",children:"2.1 Kernel\uff08\u6838\u5fc3\uff09"}),"\n",(0,i.jsx)(n.p,{children:"\u5b9a\u4e49\u670d\u52a1\u4f9d\u8d56\u5173\u7cfb\u3002\u4f9d\u8d56\u7684\u662f\u670d\u52a1\u540d\u79f0"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"// kernel/service.go\n\n// Service \u5b9a\u4e49\u5fae\u5185\u6838\u7684\u670d\u52a1\u63a5\u53e3\n// \u4f7f\u7528\u63a5\u53e3\u5b9a\u4e49\u4ee3\u66ff\u56fa\u5b9a\u7684struct,\u4f4e\u8026\u5408\u8bbe\u8ba1\u3002\ntype Service interface {\n\tStart() error\n\tStop() error\n\tName() string\n\tHandle(Event) Reply\n\t// Dependencies \u8fd4\u56de\u4f9d\u8d56\u670d\u52a1\u540d\u79f0\n\tDependencies() []string // \u65b0\u589e\u63a5\u53e3\n}\n\n// serviceMeta \u5b9a\u4e49\u5fae\u5185\u6838\u670d\u52a1\u5143\u6570\u636e\ntype serviceMeta struct {\n    svc   Service\n    state ServiceState\n    // \u5b58\u50a8\u4f9d\u8d56\uff0c\u4e5f\u53ef\u4ee5\u4e0d\u4f7f\u7528\uff0c\u76f4\u63a5\u4f7f\u7528svc.Dependencies\n    deps  []string\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u6ce8\u518cRegister\u589e\u52a0deps"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// kernel/kernel.go\n\n// Register \u6ce8\u518c\u670d\u52a1\n// \u91cd\u547d\u540d RegisterService \u4e3a Register\nfunc (k *MicroKernel) Register(svc Service) error {\n\tk.mu.Lock()\n\tdefer k.mu.Unlock()\n\n\tname := svc.Name()\n\tif _, ok := k.services[name]; ok {\n\t\treturn errors.New("service already registered")\n\t}\n\tk.services[name] = &serviceMeta{\n\t\tsvc:   svc,\n\t\tstate: Created,\n\t\tdeps:  svc.Dependencies(),\n\t}\n\tfmt.Println("Registered:", svc.Name())\n\treturn nil\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u542f\u52a8\u670d\u52a1\u548c\u505c\u6b62\u670d\u52a1\u589e\u52a0\u62d3\u6251\u6392\u5e8f"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// kernel/kernel.go\nfunc (k *MicroKernel) topoSort() ([]string, error) {\n    k.mu.RLock()\n    defer k.mu.RUnlock()\n\n    visited := make(map[string]bool)\n    temp := make(map[string]bool)\n    result := []string{}\n    var visit func(string) error\n\n    visit = func(name string) error {\n        if temp[name] {\n            return fmt.Errorf("circular dependency at %s", name)\n        }\n        if visited[name] {\n            return nil\n        }\n        temp[name] = true\n        meta, ok := k.services[name]\n        if !ok {\n            return fmt.Errorf("service %s not registered", name)\n        }\n        for _, dep := range meta.deps {\n            if err := visit(dep); err != nil {\n                return err\n            }\n        }\n        visited[name] = true\n        temp[name] = false\n        result = append(result, name)\n        return nil\n    }\n\n    for name := range k.services {\n        if !visited[name] {\n            if err := visit(name); err != nil {\n                return nil, err\n            }\n        }\n    }\n\n    return result, nil\n}\n\nfunc (k *MicroKernel) StartAll() error {\n    sorted, err := k.topoSort()\n    // ...\n    for _, name := range sorted {\n        if err := k.StartService(name); err != nil {\n            // ...\n        }\n    }\n    return nil\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"22-\u670d\u52a1",children:"2.2 \u670d\u52a1"}),"\n",(0,i.jsx)(n.p,{children:"\u670d\u52a1\u589e\u52a0\u4f9d\u8d56\u65b9\u6cd5\u5b9e\u73b0"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func (l *LogService) Dependencies() []string {\n\treturn []string{"echo"}\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"23-\u8fd0\u884c\u7ed3\u679c",children:"2.3 \u8fd0\u884c\u7ed3\u679c"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"Registered: logger\nRegistered: echo\nStarting all services...\nServices: [echo logger]\n[echo] starting...\nStarted: echo\n[logger] starting...\nStarted: logger\n[logger] LOG: Hello, Microkernel!\n[MicroKernel] Event from logger: - Hello, Microkernel!\n[logger] got reply from kernel: Handled by kernel\n[logger] LOG: Hello, Echo!\n[MicroKernel] Event from logger: - Hello, Echo!\n[logger] got reply from kernel: echo service handled\n[MicroKernel] Send Event to unknown: Hello, Log!\n{404 Not found service }\nStopping all services...\n[logger] stopping...\nStopped: logger\n[echo] stopping...\nStopped: echo\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u67e5\u770b",(0,i.jsx)(n.a,{href:"https://gitee.com/weidongkl/weidongkl.github.io/blob/master/docs/note/golang/design/microkernel/microkernel6",children:"\u5b8c\u6574\u4ee3\u7801"})]})]})}function g(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>l,x:()=>s});var t=r(96540);const i={},o=t.createContext(i);function l(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);