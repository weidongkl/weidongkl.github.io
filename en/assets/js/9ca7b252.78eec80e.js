"use strict";(self.webpackChunkweidongkl_github_io=self.webpackChunkweidongkl_github_io||[]).push([[1521,7723],{3499:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>l,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"note/golang/design/reliability","title":"Golang \u53ef\u9760\u6027\u7f16\u7a0b\u6307\u5357","description":"\u672c\u6587\u6863\u805a\u7126\u4e8e\u9ad8\u53ef\u9760\u6027 Go \u5e94\u7528\u7684\u8bbe\u8ba1\u539f\u5219\u4e0e\u5b9e\u8df5\uff0c\u6db5\u76d6\u9519\u8bef\u5904\u7406\u3001\u8d44\u6e90\u7ba1\u7406\u3001\u5e76\u53d1\u63a7\u5236\u7b49\u6838\u5fc3\u573a\u666f\u3002","source":"@site/docs/note/golang/design/reliability.md","sourceDirName":"note/golang/design","slug":"/note/golang/design/reliability","permalink":"/en/docs/note/golang/design/reliability","draft":false,"unlisted":false,"editUrl":"https://github.com/weidongkl/weidongkl.github.io/tree/master/docs/note/golang/design/reliability.md","tags":[],"version":"current","lastUpdatedBy":"weidongkl","lastUpdatedAt":1751206426000,"frontMatter":{},"sidebar":"note","previous":{"title":"Golang \u591agoroutine\u4ea4\u4e92\u6a21\u578b","permalink":"/en/docs/note/golang/design/multi_goroutine"},"next":{"title":"Golang bcrypt","permalink":"/en/docs/note/golang/bcrypt"}}');var i=r(4848),s=r(8453);const l={},o="Golang \u53ef\u9760\u6027\u7f16\u7a0b\u6307\u5357",c={},d=[{value:"1. \u9519\u8bef\u5904\u7406\uff1a\u663e\u5f0f\u6355\u83b7\u4e0e\u4f20\u9012",id:"1-\u9519\u8bef\u5904\u7406\u663e\u5f0f\u6355\u83b7\u4e0e\u4f20\u9012",level:2},{value:"2. \u8d44\u6e90\u7ba1\u7406\uff1a<code>defer</code> \u786e\u4fdd\u91ca\u653e",id:"2-\u8d44\u6e90\u7ba1\u7406defer-\u786e\u4fdd\u91ca\u653e",level:2},{value:"3. \u5e76\u53d1\u5b89\u5168\uff1a\u907f\u514d\u7ade\u6001\u6761\u4ef6",id:"3-\u5e76\u53d1\u5b89\u5168\u907f\u514d\u7ade\u6001\u6761\u4ef6",level:2},{value:"4. \u8d85\u65f6\u63a7\u5236\uff1a\u9632\u6b62\u65e0\u9650\u963b\u585e",id:"4-\u8d85\u65f6\u63a7\u5236\u9632\u6b62\u65e0\u9650\u963b\u585e",level:2},{value:"5. \u4f18\u96c5\u9000\u51fa\uff1a\u4fe1\u53f7\u5904\u7406\u4e0e\u6e05\u7406",id:"5-\u4f18\u96c5\u9000\u51fa\u4fe1\u53f7\u5904\u7406\u4e0e\u6e05\u7406",level:2},{value:"6. \u9632\u5fa1\u6027\u7f16\u7a0b\uff1a\u8f93\u5165\u6821\u9a8c",id:"6-\u9632\u5fa1\u6027\u7f16\u7a0b\u8f93\u5165\u6821\u9a8c",level:2},{value:"7. \u6d4b\u8bd5\u8986\u76d6\u7387\uff1a\u9a8c\u8bc1\u53ef\u9760\u6027",id:"7-\u6d4b\u8bd5\u8986\u76d6\u7387\u9a8c\u8bc1\u53ef\u9760\u6027",level:2},{value:"<strong>\u6700\u4f73\u5b9e\u8df5\u603b\u7ed3</strong>",id:"\u6700\u4f73\u5b9e\u8df5\u603b\u7ed3",level:2}];function a(n){const e={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"golang-\u53ef\u9760\u6027\u7f16\u7a0b\u6307\u5357",children:"Golang \u53ef\u9760\u6027\u7f16\u7a0b\u6307\u5357"})}),"\n",(0,i.jsxs)(e.p,{children:["\u672c\u6587\u6863\u805a\u7126\u4e8e",(0,i.jsx)(e.strong,{children:"\u9ad8\u53ef\u9760\u6027 Go \u5e94\u7528\u7684\u8bbe\u8ba1\u539f\u5219\u4e0e\u5b9e\u8df5"}),"\uff0c\u6db5\u76d6\u9519\u8bef\u5904\u7406\u3001\u8d44\u6e90\u7ba1\u7406\u3001\u5e76\u53d1\u63a7\u5236\u7b49\u6838\u5fc3\u573a\u666f\u3002"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"1-\u9519\u8bef\u5904\u7406\u663e\u5f0f\u6355\u83b7\u4e0e\u4f20\u9012",children:"1. \u9519\u8bef\u5904\u7406\uff1a\u663e\u5f0f\u6355\u83b7\u4e0e\u4f20\u9012"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'// \u6c38\u8fdc\u5ffd\u7565\u9519\u8bef = \u57cb\u4e0b\u5b9a\u65f6\u70b8\u5f39\nfunc ReadConfig(path string) (*Config, error) {\n    data, err := os.ReadFile(path)\n    if err != nil {\n        // \u8ffd\u52a0\u4e0a\u4e0b\u6587\u4fe1\u606f\u5411\u4e0a\u4f20\u9012\n        return nil, fmt.Errorf("read config failed: %w", err)\n    }\n    var cfg Config\n    if err := json.Unmarshal(data, &cfg); err != nil {\n        return nil, fmt.Errorf("parse config failed: %w", err)\n    }\n    return &cfg, nil\n}\n\n// \u8c03\u7528\u65b9\u5fc5\u987b\u5904\u7406\u9519\u8bef\ncfg, err := ReadConfig("config.json")\nif err != nil {\n    log.Fatalf("Fatal error: %v", err) // \u6216\u4f18\u96c5\u964d\u7ea7\n}\n'})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsxs)(e.h2,{id:"2-\u8d44\u6e90\u7ba1\u7406defer-\u786e\u4fdd\u91ca\u653e",children:["2. \u8d44\u6e90\u7ba1\u7406\uff1a",(0,i.jsx)(e.code,{children:"defer"})," \u786e\u4fdd\u91ca\u653e"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:"func ProcessFile(path string) error {\n    file, err := os.Open(path)\n    if err != nil {\n        return err\n    }\n    defer file.Close() // \u65e0\u8bba\u51fd\u6570\u5982\u4f55\u9000\u51fa\u90fd\u4f1a\u6267\u884c\n\n    scanner := bufio.NewScanner(file)\n    for scanner.Scan() {\n        // \u5904\u7406\u6570\u636e\n    }\n    return scanner.Err() // \u8fd4\u56de\u626b\u63cf\u9519\u8bef\n}\n"})}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u5173\u952e\u70b9"}),"\uff1a\u5bf9\u6570\u636e\u5e93\u8fde\u63a5\u3001\u7f51\u7edc\u53e5\u67c4\u7b49\u8d44\u6e90\u540c\u6837\u9002\u7528\u3002"]}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"3-\u5e76\u53d1\u5b89\u5168\u907f\u514d\u7ade\u6001\u6761\u4ef6",children:"3. \u5e76\u53d1\u5b89\u5168\uff1a\u907f\u514d\u7ade\u6001\u6761\u4ef6"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:"type SafeCounter struct {\n    mu    sync.Mutex\n    count int\n}\n\nfunc (c *SafeCounter) Increment() {\n    c.mu.Lock()\n    defer c.mu.Unlock() // defer \u89e3\u9501\u786e\u4fdd\u5f02\u5e38\u5b89\u5168\n    c.count++\n}\n\n// \u4f7f\u7528 sync/atomic \u7684\u65e0\u9501\u4f18\u5316\nvar atomicCount int64\natomic.AddInt64(&atomicCount, 1) // \u539f\u5b50\u64cd\u4f5c\n"})}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u68c0\u6d4b\u5de5\u5177"}),"\uff1a",(0,i.jsx)(e.code,{children:"go run -race your_app.go"})]}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"4-\u8d85\u65f6\u63a7\u5236\u9632\u6b62\u65e0\u9650\u963b\u585e",children:"4. \u8d85\u65f6\u63a7\u5236\uff1a\u9632\u6b62\u65e0\u9650\u963b\u585e"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'func FetchData(ctx context.Context, url string) ([]byte, error) {\n    req, _ := http.NewRequestWithContext(ctx, "GET", url, nil)\n    resp, err := http.DefaultClient.Do(req)\n    if err != nil {\n        return nil, err\n    }\n    defer resp.Body.Close()\n    return io.ReadAll(resp.Body)\n}\n\n// \u8c03\u7528\u65b9\u8bbe\u7f6e\u8d85\u65f6\nctx, cancel := context.WithTimeout(context.Background(), 3*time.Second)\ndefer cancel()\ndata, err := FetchData(ctx, "https://api.example.com")\n'})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"5-\u4f18\u96c5\u9000\u51fa\u4fe1\u53f7\u5904\u7406\u4e0e\u6e05\u7406",children:"5. \u4f18\u96c5\u9000\u51fa\uff1a\u4fe1\u53f7\u5904\u7406\u4e0e\u6e05\u7406"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'func main() {\n    stop := make(chan os.Signal, 1)\n    signal.Notify(stop, syscall.SIGINT, syscall.SIGTERM)\n\n    server := &http.Server{Addr: ":8080"}\n    go func() {\n        if err := server.ListenAndServe(); err != http.ErrServerClosed {\n            log.Fatalf("Server error: %v", err)\n        }\n    }()\n\n    <-stop // \u963b\u585e\u7b49\u5f85\u7ec8\u6b62\u4fe1\u53f7\n    ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)\n    defer cancel()\n    if err := server.Shutdown(ctx); err != nil { // \u4f18\u96c5\u5173\u95ed\n        log.Printf("Forced shutdown: %v", err)\n    }\n}\n'})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"6-\u9632\u5fa1\u6027\u7f16\u7a0b\u8f93\u5165\u6821\u9a8c",children:"6. \u9632\u5fa1\u6027\u7f16\u7a0b\uff1a\u8f93\u5165\u6821\u9a8c"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'func ValidateInput(input UserInput) error {\n    if input.Email == "" {\n        return errors.New("email cannot be empty")\n    }\n    if !strings.Contains(input.Email, "@") {\n        return errors.New("invalid email format")\n    }\n    if input.Age < 18 {\n        return errors.New("age must be >= 18")\n    }\n    return nil\n}\n\n// \u5728\u5165\u53e3\u5904\u5f3a\u5236\u6821\u9a8c\nerr := ValidateInput(req.Data)\nif err != nil {\n    http.Error(w, err.Error(), http.StatusBadRequest)\n    return\n}\n'})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"7-\u6d4b\u8bd5\u8986\u76d6\u7387\u9a8c\u8bc1\u53ef\u9760\u6027",children:"7. \u6d4b\u8bd5\u8986\u76d6\u7387\uff1a\u9a8c\u8bc1\u53ef\u9760\u6027"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'// \u5355\u5143\u6d4b\u8bd5 + \u9519\u8bef\u6ce8\u5165\nfunc TestReadConfig_FileNotExist(t *testing.T) {\n    _, err := ReadConfig("non_existent.json")\n    if err == nil {\n        t.Fatal("Expected error but got nil")\n    }\n    if !os.IsNotExist(err) {\n        t.Errorf("Unexpected error: %v", err)\n    }\n}\n\n// \u538b\u529b\u6d4b\u8bd5\nfunc BenchmarkConcurrentIncrement(b *testing.B) {\n    counter := SafeCounter{}\n    b.RunParallel(func(pb *testing.PB) {\n        for pb.Next() {\n            counter.Increment()\n        }\n    })\n}\n'})}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u76ee\u6807"}),"\uff1a\u6838\u5fc3\u903b\u8f91\u8986\u76d6\u7387 > 80%\uff0c\u9519\u8bef\u5206\u652f\u5fc5\u987b\u8986\u76d6\u3002"]}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u6700\u4f73\u5b9e\u8df5\u603b\u7ed3",children:(0,i.jsx)(e.strong,{children:"\u6700\u4f73\u5b9e\u8df5\u603b\u7ed3"})}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u539f\u5219"}),(0,i.jsx)(e.th,{children:"\u5b9e\u73b0\u65b9\u5f0f"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"\u5feb\u901f\u5931\u8d25"})}),(0,i.jsx)(e.td,{children:"\u8f93\u5165\u6821\u9a8c\u524d\u7f6e + \u7acb\u5373\u8fd4\u56de\u9519\u8bef"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"\u8d44\u6e90\u96f6\u6cc4\u6f0f"})}),(0,i.jsxs)(e.td,{children:[(0,i.jsx)(e.code,{children:"defer"})," + \u4e0a\u4e0b\u6587\u53d6\u6d88\u4f20\u64ad"]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"\u5e76\u53d1\u5b89\u5168"})}),(0,i.jsxs)(e.td,{children:[(0,i.jsx)(e.code,{children:"sync.Mutex"})," / ",(0,i.jsx)(e.code,{children:"atomic"})]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"\u8d85\u65f6\u63a7\u5236"})}),(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"context.WithTimeout"})})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"\u4f18\u96c5\u7ec8\u6b62"})}),(0,i.jsx)(e.td,{children:"\u4fe1\u53f7\u5904\u7406 + \u6e05\u7406\u534f\u7a0b"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"\u53ef\u89c2\u6d4b\u6027"})}),(0,i.jsx)(e.td,{children:"\u7ed3\u6784\u5316\u65e5\u5fd7 + Metrics \u57cb\u70b9"})]})]})]}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u5de5\u5177\u94fe"}),"\uff1a"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u7ade\u6001\u68c0\u6d4b\uff1a",(0,i.jsx)(e.code,{children:"go build -race"})]}),"\n",(0,i.jsxs)(e.li,{children:["\u6027\u80fd\u5206\u6790\uff1a",(0,i.jsx)(e.code,{children:"pprof"})," + ",(0,i.jsx)(e.code,{children:"go tool trace"})]}),"\n",(0,i.jsxs)(e.li,{children:["\u4f9d\u8d56\u68c0\u67e5\uff1a",(0,i.jsx)(e.code,{children:"go mod why"}),"/",(0,i.jsx)(e.code,{children:"go mod vendor"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"\u901a\u8fc7\u4e25\u683c\u6267\u884c\u4ee5\u4e0a\u89c4\u8303\uff0c\u53ef\u663e\u8457\u63d0\u5347 Go \u670d\u52a1\u7684\u53ef\u9760\u6027\u6c34\u5e73\u3002"})]})}function h(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(a,{...n})}):a(n)}},8453:(n,e,r)=>{r.d(e,{R:()=>l,x:()=>o});var t=r(6540);const i={},s=t.createContext(i);function l(n){const e=t.useContext(s);return t.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:l(n.components),t.createElement(s.Provider,{value:e},n.children)}}}]);