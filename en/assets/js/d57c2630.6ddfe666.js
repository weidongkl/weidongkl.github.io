"use strict";(self.webpackChunkweidongkl_github_io=self.webpackChunkweidongkl_github_io||[]).push([[7685],{943:(n,t,e)=>{e.r(t),e.d(t,{assets:()=>a,contentTitle:()=>o,default:()=>i,frontMatter:()=>l,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"note/golang/design/multi_goroutine","title":"Golang \u591agoroutine\u4ea4\u4e92\u6a21\u578b","description":"1. channel \u4ea4\u4e92","source":"@site/docs/note/golang/design/multi_goroutine.md","sourceDirName":"note/golang/design","slug":"/note/golang/design/multi_goroutine","permalink":"/en/docs/note/golang/design/multi_goroutine","draft":false,"unlisted":false,"editUrl":"https://github.com/weidongkl/weidongkl.github.io/tree/master/docs/note/golang/design/multi_goroutine.md","tags":[],"version":"current","lastUpdatedBy":"weidongkl","lastUpdatedAt":1745673158000,"frontMatter":{},"sidebar":"note","previous":{"title":"Future-Proof \u673a\u5236","permalink":"/en/docs/note/golang/design/future_proof"},"next":{"title":"Golang bcrypt","permalink":"/en/docs/note/golang/bcrypt"}}');var s=e(4848),c=e(8453);const l={},o="Golang \u591agoroutine\u4ea4\u4e92\u6a21\u578b",a={},d=[{value:"1. channel \u4ea4\u4e92",id:"1-channel-\u4ea4\u4e92",level:2},{value:"2.  \u589e\u52a0 channel \u72b6\u6001\u5224\u65ad",id:"2--\u589e\u52a0-channel-\u72b6\u6001\u5224\u65ad",level:2},{value:"2.1. \u7406\u89e3 channel \u884c\u4e3a",id:"21-\u7406\u89e3-channel-\u884c\u4e3a",level:3},{value:"2.2. \u4f7f\u7528\u5224\u65adchannel \u4f18\u5316\u793a\u4f8b",id:"22-\u4f7f\u7528\u5224\u65adchannel-\u4f18\u5316\u793a\u4f8b",level:3},{value:"3. \u652f\u6301 <code>context.Context</code>",id:"3-\u652f\u6301-contextcontext",level:2},{value:"4. CommandHandler \u6a21\u5f0f",id:"4-commandhandler-\u6a21\u5f0f",level:2}];function u(n){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"golang-\u591agoroutine\u4ea4\u4e92\u6a21\u578b",children:"Golang \u591agoroutine\u4ea4\u4e92\u6a21\u578b"})}),"\n",(0,s.jsx)(t.h2,{id:"1-channel-\u4ea4\u4e92",children:"1. channel \u4ea4\u4e92"}),"\n",(0,s.jsx)(t.p,{children:"\u4f7f\u7528channel \u5728 goroutine \u95f4\u8fdb\u884c\u901a\u4fe1\u548c\u540c\u6b65\u64cd\u4f5c"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'package main\n\nimport (\n\t"fmt"\n\t"time"\n)\n\n// SetRulesRequest \u8868\u793a\u8bbe\u7f6e\u89c4\u5219\u7684\u8bf7\u6c42\u7ed3\u6784\ntype SetRulesRequest struct {\n\tNewRules []string\n\tResponse chan error // \u7528\u4e8e\u540c\u6b65\u8fd4\u56de\u662f\u5426\u6210\u529f\n}\n\n// Aggregator \u7528\u4e8e\u7ba1\u7406\u89c4\u5219\u5e76\u652f\u6301\u5e76\u53d1\u8bbe\u7f6e\ntype Aggregator struct {\n\trules        []string\n\tsetRulesChan chan *SetRulesRequest\n\tstopChan     chan struct{}\n}\n\n// SetRules \u662f\u5411 aggregator \u53d1\u9001\u65b0\u89c4\u5219\u7684\u63a5\u53e3\nfunc (a *Aggregator) SetRules(r []string) error {\n\treq := &SetRulesRequest{\n\t\tNewRules: r,\n\t\tResponse: make(chan error),\n\t}\n\ta.setRulesChan <- req\n\treturn <-req.Response // \u7b49\u5f85\u54cd\u5e94\u7ed3\u675f\n}\n\n// Run \u542f\u52a8 aggregator \u7684\u5de5\u4f5c\u534f\u7a0b\nfunc (a *Aggregator) Run() {\n\tfor {\n\t\tselect {\n\t\tcase req := <-a.setRulesChan:\n\t\t\ta.rules = req.NewRules\n\t\t\tfmt.Println("Updated rules:", a.rules)\n\t\t\treq.Response <- nil // \u6210\u529f\u54cd\u5e94\n\t\tcase <-a.stopChan:\n\t\t\treturn\n\t\t}\n\t}\n}\n\n// Stop \u5173\u95ed aggregator \u7684\u540e\u53f0\u534f\u7a0b\nfunc (a *Aggregator) Stop() {\n\tclose(a.stopChan)\n}\n\nfunc main() {\n\taggregator := &Aggregator{\n\t\trules:        []string{},\n\t\tsetRulesChan: make(chan *SetRulesRequest),\n\t\tstopChan:     make(chan struct{}),\n\t}\n\n\tgo aggregator.Run()\n\n\t// \u6a21\u62df\u4f7f\u7528\n\ttime.Sleep(500 * time.Millisecond)\n\taggregator.SetRules([]string{"a", "b", "c"})\n\taggregator.SetRules([]string{"d", "e", "f"})\n\n\t// \u505c\u6b62\u540e\u53f0\u534f\u7a0b\n\taggregator.Stop()\n}\n'})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"\ud83d\udd0d \u8bf4\u660e\u91cd\u70b9\uff1a"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["\u901a\u4fe1\u6a21\u578b\uff1a\u8c03\u7528\u8005\u901a\u8fc7 ",(0,s.jsx)(t.code,{children:"SetRules"})," \u5411 ",(0,s.jsx)(t.code,{children:"Aggregator"})," \u7684 channel \u53d1\u9001\u6570\u636e\uff0c\u7136\u540e\u901a\u8fc7\u4e00\u4e2a ",(0,s.jsx)(t.code,{children:"Response"})," channel \u540c\u6b65\u7b49\u5f85\u6267\u884c\u7ed3\u679c\u3002"]}),"\n",(0,s.jsx)(t.li,{children:"\u54cd\u5e94\u5f0f\u8bbe\u8ba1\uff1aAggregator \u5904\u7406\u8bf7\u6c42\u540e\u901a\u8fc7 channel \u56de\u590d\uff0c\u907f\u514d\u7ade\u6001\u3002"}),"\n",(0,s.jsx)(t.li,{children:"\u6613\u6269\u5c55\u6027\uff1a\u4f60\u53ef\u4ee5\u5c06\u66f4\u591a\u64cd\u4f5c\uff08\u5982\u67e5\u8be2\u3001\u8ffd\u52a0\u7b49\uff09\u5c01\u88c5\u6210\u4e0d\u540c\u7684 request \u7ed3\u6784\u4f53\uff0c\u5e76\u901a\u8fc7\u4e0d\u540c channel \u6216\u7c7b\u578b\u533a\u5206\u5904\u7406\u3002"}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"2--\u589e\u52a0-channel-\u72b6\u6001\u5224\u65ad",children:"2.  \u589e\u52a0 channel \u72b6\u6001\u5224\u65ad"}),"\n",(0,s.jsx)(t.h3,{id:"21-\u7406\u89e3-channel-\u884c\u4e3a",children:"2.1. \u7406\u89e3 channel \u884c\u4e3a"}),"\n",(0,s.jsxs)(t.p,{children:["\u53d1\u9001\u7aef\uff08",(0,s.jsx)(t.code,{children:"ch <- v"}),"\uff09\u5411\u5df2\u5173\u95ed channel \u53d1\u9001\u6570\u636e\uff1a"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"\u4f1a panic\uff01"}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["\u63a5\u6536\u7aef\uff08",(0,s.jsx)(t.code,{children:"<-chan"}),"\uff09\u8bfb\u53d6\u5df2\u5173\u95ed channel\uff1a"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"\u4e0d\u4f1a panic\uff0c"}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"\u7acb\u5373\u8fd4\u56de\u96f6\u503c"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"\u7b2c\u4e8c\u4e2a\u8fd4\u56de\u503c\u5224\u65ad\u662f\u5426\u5173\u95ed"}),"\u3002\u5373\uff1a",(0,s.jsx)(t.code,{children:"v, ok := <-ch"}),"\uff0c\u5982\u679c ",(0,s.jsx)(t.code,{children:"ok == false"}),"\uff0c\u8bf4\u660e channel \u5df2\u5173\u95ed\u3002"]}),"\n",(0,s.jsxs)(t.li,{children:["\u4e0d\u5224\u65ad\u3002\u5373: ",(0,s.jsx)(t.code,{children:"v := <-ch"}),"\uff0c\u7acb\u5373\u8fd4\u56de\u96f6\u503c\uff0c\u65e0\u6cd5\u5224\u65ad channel \u662f\u5426\u5173\u95ed\u3002"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\u5373\uff1a",(0,s.jsx)(t.code,{children:"v, ok := <-ch"}),"\uff0c\u5982\u679c ",(0,s.jsx)(t.code,{children:"ok == false"}),"\uff0c\u8bf4\u660e channel \u5df2\u5173\u95ed\u3002"]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"\u4e3e\u4f8b"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'package main\n\nimport (\n\t"log"\n\t"time"\n)\n\nfunc main() {\n\t//ch := make(chan int, 2)\n\tch := make(chan int)\n\tgo func() {\n\t\tch <- 20\n\t\ttime.Sleep(1 * time.Second)\n\t\tdefer close(ch)\n\t}()\n\t// \u53ea\u63a5\u6536\u6570\u636e\uff0c\u4e0d\u68c0\u67e5\u901a\u9053\u72b6\u6001\n\trules := <-ch\n\tlog.Println("Rules:", rules) // \u8f93\u51fa\uff1a14:47:31 Rules: 20\n\trules = <-ch\n\tlog.Println("Rules:", rules) // \u8f93\u51fa\uff1a14:47:32 Rules: 0\n\trules = <-ch\n\tlog.Println("Rules:", rules) // \u8f93\u51fa\uff1a14:47:32 Rules: 0\n\t// \u8bfb\u53d6\u65f6\u68c0\u67e5\u901a\u9053\u662f\u5426\u4ecd\u7136\u5f00\u653e\n\trules, open := <-ch\n\tlog.Println("Rules:", rules, "Open:", open) // \u8f93\u51fa\uff1a14:46:39 Rules: 20 Open: true\n\trules, open = <-ch\n\tlog.Println("Rules:", rules, "Open:", open) // \u8f93\u51fa\uff1a14:46:40 Rules: 0 Open: false\n\trules, open = <-ch\n\tlog.Println("Rules:", rules, "Open:", open) // \u8f93\u51fa\uff1a14:46:40 Rules: 0 Open: false\n}\n\n'})}),"\n",(0,s.jsx)(t.h3,{id:"22-\u4f7f\u7528\u5224\u65adchannel-\u4f18\u5316\u793a\u4f8b",children:"2.2. \u4f7f\u7528\u5224\u65adchannel \u4f18\u5316\u793a\u4f8b"}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"\u2705 \u7279\u6027\u4eae\u70b9\uff1a"})}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["\u5b89\u5168\u5173\u95ed goroutine\uff1a","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"setRulesChan"})," \u548c ",(0,s.jsx)(t.code,{children:"stopChan"})," \u90fd\u652f\u6301\u5173\u95ed\uff0c\u9632\u6b62\u6b7b\u9501\u6216 panic\u3002"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\u5e26 ",(0,s.jsx)(t.code,{children:"ok"})," \u5224\u65ad\u9632\u6b62\u63a5\u6536\u5df2\u5173\u95ed\u7684 channel \u5bfc\u81f4\u6570\u636e\u4e3a nil\u3002"]}),"\n",(0,s.jsxs)(t.li,{children:["\u5c01\u88c5\u6e05\u6670\uff1a ",(0,s.jsx)(t.code,{children:"Run()"})," \u6267\u884c\u903b\u8f91\u6e05\u6670\uff0c",(0,s.jsx)(t.code,{children:"Stop()"})," \u65b9\u6cd5\u8d1f\u8d23\u5b89\u5168\u9000\u51fa\u548c\u8d44\u6e90\u6e05\u7406\u3002"]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'package main\n\nimport (\n\t"fmt"\n\t"time"\n)\n\n// \u8bf7\u6c42\u7ed3\u6784\u4f53\uff0c\u8bbe\u7f6e\u89c4\u5219\u5e76\u901a\u8fc7 Response \u8fd4\u56de\u7ed3\u679c\ntype SetRulesRequest struct {\n\tNewRules []string\n\tResponse chan error\n}\n\n// \u805a\u5408\u5668\u7ed3\u6784\ntype Aggregator struct {\n\trules        []string\n\tsetRulesChan chan *SetRulesRequest\n\tstopChan     chan struct{}\n\tdoneChan     chan struct{} // \u901a\u77e5\u4e3b\u7ebf\u7a0b\u5df2\u9000\u51fa\n}\n\n// Run \u542f\u52a8 Aggregator \u7684\u5de5\u4f5c\u534f\u7a0b\nfunc (a *Aggregator) Run() {\n\tdefer close(a.doneChan) // \u901a\u77e5\u4e3b\u7ebf\u7a0b\uff1a\u540e\u53f0\u534f\u7a0b\u5df2\u9000\u51fa\n\n\tfor {\n\t\tselect {\n\t\tcase req, ok := <-a.setRulesChan:\n\t\t\tif !ok {\n\t\t\t\tfmt.Println("setRulesChan closed, exiting Run()")\n\t\t\t\treturn\n\t\t\t}\n\t\t\ta.rules = req.NewRules\n\t\t\tfmt.Println("Updated rules:", a.rules)\n\t\t\t// \u54cd\u5e94\u8c03\u7528\u8005\n\t\t\treq.Response <- nil\n\n\t\tcase <-a.stopChan:\n\t\t\tfmt.Println("Received stop signal, exiting Run()")\n\t\t\treturn\n\t\t}\n\t}\n}\n\n// SetRules \u53d1\u9001\u89c4\u5219\u8bf7\u6c42\nfunc (a *Aggregator) SetRules(r []string) error {\n\treq := &SetRulesRequest{\n\t\tNewRules: r,\n\t\tResponse: make(chan error),\n\t}\n\n\tselect {\n\tcase a.setRulesChan <- req:\n\t\treturn <-req.Response\n\tcase <-a.stopChan:\n\t\treturn fmt.Errorf("aggregator is shutting down")\n\t}\n}\n\n// Stop \u5173\u95ed aggregator\uff0c\u786e\u4fdd goroutine \u4f18\u96c5\u9000\u51fa\nfunc (a *Aggregator) Stop() {\n\tclose(a.stopChan)     // \u901a\u77e5\u9000\u51fa\n\tclose(a.setRulesChan) // \u9632\u6b62\u963b\u585e\u5728 <-setRulesChan\n\t<-a.doneChan          // \u7b49\u5f85\u540e\u53f0\u5904\u7406\u5b8c\u6210\n\tfmt.Println("Aggregator stopped gracefully")\n}\n\nfunc main() {\n\taggregator := &Aggregator{\n\t\trules:        []string{},\n\t\tsetRulesChan: make(chan *SetRulesRequest),\n\t\tstopChan:     make(chan struct{}),\n\t\tdoneChan:     make(chan struct{}),\n\t}\n\n\tgo aggregator.Run()\n\n\ttime.Sleep(500 * time.Millisecond)\n\taggregator.SetRules([]string{"a", "b", "c"})\n\taggregator.SetRules([]string{"x", "y", "z"})\n\n\taggregator.Stop()\n}\n'})}),"\n",(0,s.jsxs)(t.h2,{id:"3-\u652f\u6301-contextcontext",children:["3. \u652f\u6301 ",(0,s.jsx)(t.code,{children:"context.Context"})]}),"\n",(0,s.jsxs)(t.p,{children:["\ud83e\udde0 \u4e3a\u5565\u7528 ",(0,s.jsx)(t.code,{children:"context.Context"}),"\uff1f"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"\u9632\u6b62\u8c03\u7528\u8005\u88ab\u6c38\u4e45\u963b\u585e\uff1a\u4f8b\u5982 aggregator goroutine \u8fdf\u8fdf\u4e0d\u54cd\u5e94\u3002"}),"\n",(0,s.jsx)(t.li,{children:"\u53ef\u8bbe\u7f6e timeout \u6216 cancel\uff0c\u9002\u5408\u670d\u52a1\u7aef\u7f16\u7a0b\u6a21\u578b\u3002"}),"\n",(0,s.jsx)(t.li,{children:"\u53ef\u7ec4\u5408\u591a\u79cd\u53d6\u6d88\u65b9\u5f0f\uff08\u5b9a\u65f6\u53d6\u6d88 + \u4e3b\u52a8\u53d6\u6d88\uff09\u3002"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"\u2705 \u589e\u5f3a\u529f\u80fd\uff1a"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"SetRules"})," \u652f\u6301\u8d85\u65f6 / \u53d6\u6d88\uff08\u907f\u514d\u5361\u6b7b\u7b49\u5f85\u54cd\u5e94\uff09\u3002"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"context.Context"})," \u63a7\u5236\u54cd\u5e94\u7b49\u5f85\u8fc7\u7a0b\u3002"]}),"\n",(0,s.jsxs)(t.li,{children:["\u4f9d\u7136\u4fdd\u7559 graceful shutdown \u652f\u6301\uff08",(0,s.jsx)(t.code,{children:"Stop()"}),"\uff09\u3002"]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'package main\n\nimport (\n\t"context"\n\t"fmt"\n\t"time"\n)\n\n// \u8bf7\u6c42\u7ed3\u6784\u4f53\uff0c\u8bbe\u7f6e\u89c4\u5219\u5e76\u901a\u8fc7 Response \u8fd4\u56de\u7ed3\u679c\ntype SetRulesRequest struct {\n\tNewRules []string\n\tResponse chan error\n}\n\n// \u805a\u5408\u5668\u7ed3\u6784\u4f53\ntype Aggregator struct {\n\trules        []string\n\tsetRulesChan chan *SetRulesRequest\n\tstopChan     chan struct{}\n\tdoneChan     chan struct{}\n}\n\n// Run \u542f\u52a8 aggregator \u7684\u5de5\u4f5c\u534f\u7a0b\nfunc (a *Aggregator) Run() {\n\tdefer close(a.doneChan)\n\n\tfor {\n\t\tselect {\n\t\tcase req, ok := <-a.setRulesChan:\n\t\t\tif !ok {\n\t\t\t\tfmt.Println("setRulesChan closed, exiting Run()")\n\t\t\t\treturn\n\t\t\t}\n\t\t\ta.rules = req.NewRules\n\t\t\tfmt.Println("Updated rules:", a.rules)\n\t\t\treq.Response <- nil\n\n\t\tcase <-a.stopChan:\n\t\t\tfmt.Println("Received stop signal, exiting Run()")\n\t\t\treturn\n\t\t}\n\t}\n}\n\n// SetRulesCtx \u652f\u6301 context \u8d85\u65f6 / \u53d6\u6d88\u63a7\u5236\nfunc (a *Aggregator) SetRulesCtx(ctx context.Context, rules []string) error {\n\treq := &SetRulesRequest{\n\t\tNewRules: rules,\n\t\tResponse: make(chan error, 1), // \u975e\u963b\u585e\u56de\u5199\n\t}\n\t// \u6a21\u62df\u8017\u65f6\u64cd\u4f5c\n\ttime.Sleep(2 * time.Millisecond)\n\tselect {\n\tcase a.setRulesChan <- req:\n\t\t// \u7b49\u5f85\u54cd\u5e94 or context \u8d85\u65f6\n\t\tselect {\n\t\tcase err := <-req.Response:\n\t\t\treturn err\n\t\tcase <-ctx.Done():\n\t\t\treturn fmt.Errorf("set rules timeout or cancelled: %w", ctx.Err())\n\t\t}\n\tcase <-a.stopChan:\n\t\treturn fmt.Errorf("aggregator shutting down")\n\tcase <-ctx.Done():\n\t\treturn fmt.Errorf("send timeout or cancelled: %w", ctx.Err())\n\t}\n}\n\n// Stop \u4f18\u96c5\u5173\u95ed\nfunc (a *Aggregator) Stop() {\n\tclose(a.stopChan)\n\tclose(a.setRulesChan)\n\t<-a.doneChan\n\tfmt.Println("Aggregator stopped gracefully")\n}\n\nfunc main() {\n\taggregator := &Aggregator{\n\t\trules:        []string{},\n\t\tsetRulesChan: make(chan *SetRulesRequest),\n\t\tstopChan:     make(chan struct{}),\n\t\tdoneChan:     make(chan struct{}),\n\t}\n\n\tgo aggregator.Run()\n\n\t// \u6a21\u62df\u6b63\u5e38\u8c03\u7528\n\tctx := context.Background()\n\taggregator.SetRulesCtx(ctx, []string{"a", "b", "c"})\n\n\t// \u6a21\u62df\u5e26 timeout \u7684\u8c03\u7528\uff081ms \u4f1a\u8d85\u65f6\uff09\n\tctxTimeout, cancel := context.WithTimeout(context.Background(), 1*time.Millisecond)\n\tdefer cancel()\n\terr := aggregator.SetRulesCtx(ctxTimeout, []string{"should", "fail", "fast"})\n\tif err != nil {\n\t\tfmt.Println("Timeout err:", err)\n\t}\n\n\t// \u6b63\u5e38\u8c03\u7528\n\tctx2, cancel2 := context.WithTimeout(context.Background(), 2*time.Second)\n\tdefer cancel2()\n\taggregator.SetRulesCtx(ctx2, []string{"x", "y", "z"})\n\n\taggregator.Stop()\n}\n'})}),"\n",(0,s.jsxs)(t.h2,{id:"4-commandhandler-\u6a21\u5f0f",children:["4. ",(0,s.jsx)(t.a,{href:"https://refactoringguru.cn/design-patterns/command/go/example",children:"CommandHandler \u6a21\u5f0f"})]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"CommandHandler \u6a21\u5f0f"}),"\u662f\u547d\u4ee4\u6a21\u5f0f\uff08Command Pattern\uff09\u7684\u4e00\u79cd\u5b9e\u73b0\u65b9\u5f0f\uff0c\u5e38\u7528\u4e8e\u5c06\u8bf7\u6c42\uff08\u547d\u4ee4\uff09\u4e0e\u5904\u7406\u903b\u8f91\u89e3\u8026\uff0c\u4ece\u800c\u63d0\u9ad8\u7cfb\u7edf\u7684\u7075\u6d3b\u6027\u548c\u53ef\u6269\u5c55\u6027\u3002\u5b83\u901a\u8fc7\u5c06\u547d\u4ee4\u5c01\u88c5\u4e3a\u5bf9\u8c61\uff0c\u5e76\u7531\u4e13\u95e8\u7684 ",(0,s.jsx)(t.code,{children:"CommandHandler"})," \u8d1f\u8d23\u6267\u884c\u8fd9\u4e9b\u547d\u4ee4\uff0c\u4f7f\u5f97\u7cfb\u7edf\u80fd\u591f\u66f4\u8f7b\u677e\u5730\u7ba1\u7406\u547d\u4ee4\u7684\u751f\u547d\u5468\u671f\u3001\u652f\u6301\u64a4\u9500/\u91cd\u505a\u64cd\u4f5c\u3001\u5b9e\u73b0\u4e8b\u52a1\u7ba1\u7406\u6216\u5f02\u6b65\u5904\u7406\u3002"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"\u6838\u5fc3\u6982\u5ff5"})}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["Command\uff08\u547d\u4ee4\uff09","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["\u5b9a\u4e49\u4e00\u4e2a\u63a5\u53e3\u6216\u62bd\u8c61\u7c7b\uff0c\u58f0\u660e\u6267\u884c\u547d\u4ee4\u7684\u65b9\u6cd5\uff08\u5982 ",(0,s.jsx)(t.code,{children:"execute()"}),"\uff09\u3002"]}),"\n",(0,s.jsx)(t.li,{children:"\u5177\u4f53\u547d\u4ee4\u7c7b\u5b9e\u73b0\u8be5\u63a5\u53e3\uff0c\u5c01\u88c5\u8bf7\u6c42\u7684\u5177\u4f53\u903b\u8f91\u3002"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["CommandHandler\uff08\u547d\u4ee4\u5904\u7406\u5668\uff09","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["\u8d1f\u8d23\u63a5\u6536\u547d\u4ee4\u5bf9\u8c61\u5e76\u8c03\u7528\u5176 ",(0,s.jsx)(t.code,{children:"execute()"})," \u65b9\u6cd5\u3002"]}),"\n",(0,s.jsx)(t.li,{children:"\u53ef\u4ee5\u6269\u5c55\u4e3a\u652f\u6301\u547d\u4ee4\u7684\u8c03\u5ea6\u3001\u6392\u961f\u3001\u4e8b\u52a1\u7ba1\u7406\u6216\u5f02\u6b65\u6267\u884c\u3002"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["Invoker\uff08\u8c03\u7528\u8005\uff09","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["\u89e6\u53d1\u547d\u4ee4\u7684\u5bf9\u8c61\uff0c\u901a\u5e38\u6301\u6709\u5bf9 ",(0,s.jsx)(t.code,{children:"CommandHandler"})," \u7684\u5f15\u7528\u3002"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["Receiver\uff08\u63a5\u6536\u8005\uff09","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"\u6267\u884c\u547d\u4ee4\u5b9e\u9645\u903b\u8f91\u7684\u5bf9\u8c61\uff0c\u547d\u4ee4\u5bf9\u8c61\u901a\u8fc7\u4f9d\u8d56\u6ce8\u5165\u6216\u7ec4\u5408\u7684\u65b9\u5f0f\u4e0e\u63a5\u6536\u8005\u4ea4\u4e92\u3002"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"\ud83c\udfaf \u76ee\u6807\uff1a"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"\u652f\u6301\u4e0d\u540c\u7c7b\u578b\u8bf7\u6c42\u7684\u7edf\u4e00\u5904\u7406\u901a\u9053"}),"\n",(0,s.jsx)(t.li,{children:"\u7c7b\u4f3c\u201c\u547d\u4ee4\u6a21\u5f0f\u201d\uff1a\u5c06\u64cd\u4f5c\u5c01\u88c5\u4e3a\u4e00\u4e2a\u7ed3\u6784\u4f53"}),"\n",(0,s.jsx)(t.li,{children:"\u53ef\u6269\u5c55\u3001\u53ef\u6d4b\u8bd5\u3001context \u652f\u6301\u3001graceful shutdown"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"\u2705 \u67b6\u6784\u8bbe\u8ba1\uff1a"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"+--------------------+\n|    CommandHandler  |\n|--------------------|\n| chan Command       |<----------- Send()\n| goroutine: dispatch|     (\u901a\u7528\u5f02\u6b65\u63a5\u53e3)\n+--------------------+\n        |\n        V\n+--------------------+\n|    Command (\u63a5\u53e3)  |<-- \u591a\u79cd\u8bf7\u6c42\u5b9e\u73b0\uff1a\n| Execute(context)   |     - SetRulesCommand\n+--------------------+     - GetRulesCommand\n                          - AppendRulesCommand\n\n"})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"\u2728 \u901a\u7528\u5b9e\u73b0\uff08\u542b SetRules \u548c GetRules\uff09\uff1a"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'package main\n\nimport (\n\t"context"\n\t"errors"\n\t"fmt"\n)\n\n// Command \u662f\u6240\u6709\u8bf7\u6c42\u7684\u63a5\u53e3\ntype Command interface {\n\tExecute(ctx context.Context, h *Handler)\n\tDone() <-chan struct{}\n\tErr() error\n}\n\n// Handler \u7ba1\u7406\u72b6\u6001\u548c\u8c03\u5ea6\u547d\u4ee4\u6267\u884c\ntype Handler struct {\n\trules   []string\n\tcmdChan chan Command\n\tstop    chan struct{}\n\tdone    chan struct{}\n}\n\n// \u57fa\u7840\u547d\u4ee4\u7ed3\u6784\ntype baseCommand struct {\n\terr  error\n\tdone chan struct{}\n}\n\nfunc (c *baseCommand) Done() <-chan struct{} {\n\treturn c.done\n}\nfunc (c *baseCommand) Err() error {\n\treturn c.err\n}\n\n// SetRulesCommand \u8bbe\u7f6e\u89c4\u5219\ntype SetRulesCommand struct {\n\tbaseCommand\n\tNewRules []string\n}\n\nfunc (c *SetRulesCommand) Execute(ctx context.Context, h *Handler) {\n\tdefer close(c.done)\n\th.rules = c.NewRules\n\tfmt.Println("SetRulesCommand executed:", h.rules)\n}\n\n// GetRulesCommand \u83b7\u53d6\u89c4\u5219\ntype GetRulesCommand struct {\n\tbaseCommand\n\tResult chan []string\n}\n\nfunc (c *GetRulesCommand) Execute(ctx context.Context, h *Handler) {\n\tdefer close(c.done)\n\tc.Result <- h.rules\n\tclose(c.Result)\n}\n\nfunc NewHandler() *Handler {\n\treturn &Handler{\n\t\trules:   []string{},\n\t\tcmdChan: make(chan Command),\n\t\tstop:    make(chan struct{}),\n\t\tdone:    make(chan struct{}),\n\t}\n}\n\n// Run \u542f\u52a8\u5904\u7406\u5faa\u73af\nfunc (h *Handler) Run() {\n\tdefer close(h.done)\n\tfor {\n\t\tselect {\n\t\tcase cmd := <-h.cmdChan:\n\t\t\tctx := context.Background() // \u53ef\u652f\u6301 ctx \u63a7\u5236\n\t\t\tcmd.Execute(ctx, h)\n\t\tcase <-h.stop:\n\t\t\treturn\n\t\t}\n\t}\n}\n\n// Send \u63d0\u4ea4\u547d\u4ee4\uff08\u5e26\u8d85\u65f6\u652f\u6301\uff09\nfunc (h *Handler) Send(ctx context.Context, cmd Command) error {\n\tselect {\n\tcase h.cmdChan <- cmd:\n\t\tselect {\n\t\tcase <-cmd.Done():\n\t\t\treturn cmd.Err()\n\t\tcase <-ctx.Done():\n\t\t\treturn ctx.Err()\n\t\t}\n\tcase <-h.stop:\n\t\treturn errors.New("handler is stopped")\n\tcase <-ctx.Done():\n\t\treturn ctx.Err()\n\t}\n}\n\n// Stop \u4f18\u96c5\u5173\u95ed\nfunc (h *Handler) Stop() {\n\tclose(h.stop)\n\t<-h.done\n}\n\nfunc main() {\n\thandler := NewHandler()\n\tgo handler.Run()\n\n\tctx := context.Background()\n\tsetCmd := &SetRulesCommand{\n\t\tbaseCommand: baseCommand{done: make(chan struct{})},\n\t\tNewRules:    []string{"a", "b", "c"},\n\t}\n\thandler.Send(ctx, setCmd)\n\n\t// \u83b7\u53d6\u89c4\u5219\n\tgetCmd := &GetRulesCommand{\n\t\tbaseCommand: baseCommand{done: make(chan struct{})},\n\t\tResult:      make(chan []string, 1),\n\t}\n\thandler.Send(ctx, getCmd)\n\n\tfmt.Println("Current rules:", <-getCmd.Result)\n\n\thandler.Stop()\n}\n\n'})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsxs)(t.strong,{children:["\u2705 \u6cdb\u578b\u5f0f\u54cd\u5e94\u7684 ",(0,s.jsx)(t.code,{children:"ResultCommand[T]"})," \u8bbe\u8ba1"]})}),"\n",(0,s.jsx)(t.p,{children:"\u5b9e\u73b0\u76ee\u6807\uff1a"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["\u547d\u4ee4\u652f\u6301\u643a\u5e26\u5f3a\u7c7b\u578b\u8fd4\u56de\u503c\uff08\u4f8b\u5982\uff1a",(0,s.jsx)(t.code,{children:"[]string"}),"\u3001",(0,s.jsx)(t.code,{children:"int"}),"\u3001bool \u7b49\uff09\uff1b"]}),"\n",(0,s.jsx)(t.li,{children:"\u652f\u6301 context \u63a7\u5236\uff1b"}),"\n",(0,s.jsxs)(t.li,{children:["\u89e3\u8026\u547d\u4ee4\u53d1\u9001\u4e0e\u6267\u884c\uff0c",(0,s.jsx)(t.strong,{children:"\u7c7b\u578b\u5b89\u5168"})," \u7684\u5f02\u6b65\u54cd\u5e94\uff1b"]}),"\n",(0,s.jsx)(t.li,{children:"\u6613\u6269\u5c55\u3001\u7ed3\u6784\u6e05\u6670\u3002"}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'package main\n\nimport (\n\t"context"\n\t"errors"\n\t"fmt"\n\t"time"\n)\n\n// \u901a\u7528 Command \u63a5\u53e3\ntype Command interface {\n\tExecute(context.Context, *Handler)\n\tDone() <-chan struct{}\n\tErr() error\n}\n\n// Handler\uff1a\u547d\u4ee4\u5904\u7406\u5668\ntype Handler struct {\n\trules   []string\n\tcmdChan chan Command\n\tstop    chan struct{}\n\tdone    chan struct{}\n}\n\nfunc NewHandler() *Handler {\n\treturn &Handler{\n\t\trules:   []string{},\n\t\tcmdChan: make(chan Command),\n\t\tstop:    make(chan struct{}),\n\t\tdone:    make(chan struct{}),\n\t}\n}\n\nfunc (h *Handler) Run() {\n\tdefer close(h.done)\n\tfor {\n\t\tselect {\n\t\tcase cmd := <-h.cmdChan:\n\t\t\tcmd.Execute(context.Background(), h)\n\t\tcase <-h.stop:\n\t\t\treturn\n\t\t}\n\t}\n}\n\nfunc (h *Handler) Stop() {\n\tclose(h.stop)\n\t<-h.done\n}\n\n// Send \u652f\u6301\u6cdb\u578b\u547d\u4ee4\u53d1\u9001\nfunc (h *Handler) Send(ctx context.Context, cmd Command) error {\n\tselect {\n\tcase h.cmdChan <- cmd:\n\t\tselect {\n\t\tcase <-cmd.Done():\n\t\t\treturn cmd.Err()\n\t\tcase <-ctx.Done():\n\t\t\treturn ctx.Err()\n\t\t}\n\tcase <-ctx.Done():\n\t\treturn ctx.Err()\n\tcase <-h.stop:\n\t\treturn errors.New("handler stopped")\n\t}\n}\n\n// \u6cdb\u578b\u547d\u4ee4 ResultCommand[T]\n// --------------------------------\ntype ResultCommand[T any] struct {\n\tresult  T\n\terr     error\n\tdone    chan struct{}\n\tresultC chan T\n}\n\nfunc NewResultCommand[T any]() *ResultCommand[T] {\n\treturn &ResultCommand[T]{\n\t\tdone:    make(chan struct{}),\n\t\tresultC: make(chan T, 1), // \u975e\u963b\u585e\u5199\u5165\n\t}\n}\n\nfunc (c *ResultCommand[T]) Done() <-chan struct{} { return c.done }\nfunc (c *ResultCommand[T]) Err() error            { return c.err }\n\n// Wait \u7b49\u5f85\u7ed3\u679c\nfunc (c *ResultCommand[T]) Wait(ctx context.Context) (T, error) {\n\tselect {\n\tcase <-ctx.Done():\n\t\tvar zero T\n\t\treturn zero, ctx.Err()\n\tcase res := <-c.resultC:\n\t\treturn res, c.err\n\t}\n}\n\n// --------------------------------\n// \u793a\u4f8b\u547d\u4ee4\uff1aGetRulesCommand \u8fd4\u56de []string\n// --------------------------------\ntype GetRulesCommand struct {\n\t*ResultCommand[[]string]\n}\n\nfunc NewGetRulesCommand() *GetRulesCommand {\n\treturn &GetRulesCommand{\n\t\tResultCommand: NewResultCommand[[]string](),\n\t}\n}\n\nfunc (c *GetRulesCommand) Execute(ctx context.Context, h *Handler) {\n\tdefer close(c.done)\n\tc.result = h.rules\n\tc.resultC <- h.rules\n}\n\n// --------------------------------\n// \u793a\u4f8b\u547d\u4ee4\uff1aSetRulesCommand\n// --------------------------------\ntype SetRulesCommand struct {\n\tnewRules []string\n\tdone     chan struct{}\n\terr      error\n}\n\nfunc NewSetRulesCommand(rules []string) *SetRulesCommand {\n\treturn &SetRulesCommand{\n\t\tnewRules: rules,\n\t\tdone:     make(chan struct{}),\n\t}\n}\n\nfunc (c *SetRulesCommand) Execute(ctx context.Context, h *Handler) {\n\tdefer close(c.done)\n\th.rules = c.newRules\n\tfmt.Println("Rules updated:", h.rules)\n}\n\nfunc (c *SetRulesCommand) Done() <-chan struct{} { return c.done }\nfunc (c *SetRulesCommand) Err() error            { return c.err }\n\n// \ud83e\uddea Main \u6f14\u793a\uff1aSetRules \u548c GetRules \u6cdb\u578b\u8fd4\u56de\nfunc main() {\n\th := NewHandler()\n\tgo h.Run()\n\n\tctx := context.Background()\n\n\t// Set rules\n\tsetCmd := NewSetRulesCommand([]string{"x", "y", "z"})\n\t_ = h.Send(ctx, setCmd)\n\n\t// Get rules\n\tgetCmd := NewGetRulesCommand()\n\t_ = h.Send(ctx, getCmd)\n\n\trules, err := getCmd.Wait(ctx)\n\tif err != nil {\n\t\tfmt.Println("GetRules error:", err)\n\t} else {\n\t\tfmt.Println("Got rules:", rules)\n\t}\n\n\t// \u8d85\u65f6\u6d4b\u8bd5\n\ttimeoutCtx, cancel := context.WithTimeout(ctx, 1*time.Millisecond)\n\tdefer cancel()\n\n\tgetCmd2 := NewGetRulesCommand()\n\t_ = h.Send(timeoutCtx, getCmd2)\n\n\trules2, err := getCmd2.Wait(timeoutCtx)\n\tfmt.Println("With timeout:", rules2, err)\n\n\th.Stop()\n}\n'})}),"\n",(0,s.jsx)(t.p,{children:"\u8f93\u51fa\u793a\u4f8b\uff1a"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"Rules updated: [x y z]\nGot rules: [x y z]\nWith timeout: [] context deadline exceeded\n"})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"\ud83d\udce6 \u53ef\u6269\u5c55\u793a\u4f8b\u547d\u4ee4"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.code,{children:"GetStatsCommand struct{ ResultCommand[map[string]int] }"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.code,{children:"FlushToDiskCommand struct{ ResultCommand[bool] }"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.code,{children:"LoadConfigCommand struct{ ResultCommand[Config] }"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.code,{children:"AppendRulesCommand struct{ Rules []string }"})}),"\n"]})]})}function i(n={}){const{wrapper:t}={...(0,c.R)(),...n.components};return t?(0,s.jsx)(t,{...n,children:(0,s.jsx)(u,{...n})}):u(n)}},8453:(n,t,e)=>{e.d(t,{R:()=>l,x:()=>o});var r=e(6540);const s={},c=r.createContext(s);function l(n){const t=r.useContext(c);return r.useMemo((function(){return"function"==typeof n?n(t):{...t,...n}}),[t,n])}function o(n){let t;return t=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:l(n.components),r.createElement(c.Provider,{value:t},n.children)}}}]);