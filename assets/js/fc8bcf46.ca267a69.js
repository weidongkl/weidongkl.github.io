"use strict";(self.webpackChunkweidongkl_github_io=self.webpackChunkweidongkl_github_io||[]).push([[6762,9621],{84728:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>g,frontMatter:()=>l,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"note/golang/design/microkernel/microkernel5","title":"microkernel \u8bbe\u8ba15","description":"1. \u76ee\u6807","source":"@site/docs/note/golang/design/microkernel/microkernel5.md","sourceDirName":"note/golang/design/microkernel","slug":"/note/golang/design/microkernel/microkernel5","permalink":"/docs/note/golang/design/microkernel/microkernel5","draft":false,"unlisted":false,"editUrl":"https://github.com/weidongkl/weidongkl.github.io/tree/master/docs/note/golang/design/microkernel/microkernel5.md","tags":[],"version":"current","lastUpdatedBy":"weidongkl","lastUpdatedAt":1764417957000,"sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"note","previous":{"title":"microkernel \u8bbe\u8ba14","permalink":"/docs/note/golang/design/microkernel/microkernel4"},"next":{"title":"microkernel \u8bbe\u8ba16","permalink":"/docs/note/golang/design/microkernel/microkernel6"}}');var i=n(74848),o=n(28453);const l={sidebar_position:5},s="microkernel \u8bbe\u8ba15",c={},a=[{value:"1. \u76ee\u6807",id:"1-\u76ee\u6807",level:2},{value:"2. \u4ee3\u7801\u6539\u52a8",id:"2-\u4ee3\u7801\u6539\u52a8",level:2},{value:"2.1 Kernel\uff08\u6838\u5fc3\uff09",id:"21-kernel\u6838\u5fc3",level:3},{value:"2.2 \u8fd0\u884c\u7ed3\u679c",id:"22-\u8fd0\u884c\u7ed3\u679c",level:3}];function d(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"microkernel-\u8bbe\u8ba15",children:"microkernel \u8bbe\u8ba15"})}),"\n",(0,i.jsx)(t.h2,{id:"1-\u76ee\u6807",children:"1. \u76ee\u6807"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"\u670d\u52a1\u72b6\u6001\u7ba1\u7406"}),"\n",(0,i.jsx)(t.li,{children:"\u5355\u72ec\u670d\u52a1\u7ba1\u7406"}),"\n",(0,i.jsx)(t.li,{children:"\u4f18\u5316\u9879\u76ee\u7ed3\u6784"}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"2-\u4ee3\u7801\u6539\u52a8",children:"2. \u4ee3\u7801\u6539\u52a8"}),"\n",(0,i.jsx)(t.h3,{id:"21-kernel\u6838\u5fc3",children:"2.1 Kernel\uff08\u6838\u5fc3\uff09"}),"\n",(0,i.jsx)(t.p,{children:"\u5b9a\u4e49\u670d\u52a1\u72b6\u6001\u548c\u670d\u52a1\u5143\u6570\u636e"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'// kernel/service.go\n// ServiceState \u5b9a\u4e49\u5fae\u5185\u6838\u670d\u52a1\u72b6\u6001\ntype ServiceState int\n\n// \u4f7f\u7528iota\u679a\u4e3e\u7c7b\u578b\uff0c\u81ea\u52a8\u8ba1\u7b97\u679a\u4e3e\u503c\nconst (\n\tCreated ServiceState = iota\n\tRunning\n\tStopped\n)\n\n// ServiceState.String()\nfunc (s ServiceState) String() string {\n\t// \u72b6\u6001\u8f6c\u6362\u6210\u5b57\u7b26\u4e32\n\t// \u5176\u4e2d[...]\u8868\u793a\u8ba9\u7f16\u8bd1\u5668\u81ea\u52a8\u8ba1\u7b97\u6570\u7ec4\u7684\u957f\u5ea6\n\treturn [...]string{"Created", "Running", "Stopped"}[s]\n}\n\n// serviceMeta \u5b9a\u4e49\u5fae\u5185\u6838\u670d\u52a1\u5143\u6570\u636e\ntype serviceMeta struct {\n\tsvc   Service\n\tstate ServiceState\n}\n\n'})}),"\n",(0,i.jsx)(t.p,{children:"\u5355\u4e2a\u670d\u52a1\u7ba1\u7406"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'// kernel/kernel.go\n\nfunc (k *MicroKernel) StartService(name string) error {\n\tk.mu.Lock()\n\tdefer k.mu.Unlock()\n\tmeta, ok := k.services[name]\n\tif !ok {\n\t\treturn errors.New("service not registered")\n\t}\n\tif meta.state == Running {\n\t\treturn errors.New("service already started")\n\t}\n\tif err := meta.svc.Start(); err != nil {\n\t\treturn err\n\t}\n\tmeta.state = Running\n\tfmt.Println("Started:", meta.svc.Name())\n\treturn nil\n}\n\nfunc (k *MicroKernel) StopService(name string) error {\n\tk.mu.Lock()\n\tdefer k.mu.Unlock()\n\tmeta, ok := k.services[name]\n\tif !ok {\n\t\treturn errors.New("service not registered")\n\t}\n\tif meta.state == Stopped {\n\t\treturn errors.New("service already stopped")\n\t}\n\tif err := meta.svc.Stop(); err != nil {\n\t\treturn err\n\t}\n\tmeta.state = Stopped\n\tfmt.Println("Stopped:", meta.svc.Name())\n\treturn nil\n}\n\n'})}),"\n",(0,i.jsx)(t.p,{children:"Listen \u589e\u52a0\u670d\u52a1\u72b6\u6001\u5224\u65ad\uff0c\u672a\u8fd0\u884c\u7684\u670d\u52a1\uff0c\u4e0d\u518d\u5904\u7406\u6d88\u606f"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'// Listen \u4e8b\u4ef6\u5faa\u73af\uff08\u5904\u7406\u670d\u52a1\u95f4\u901a\u4fe1\uff09\n// \u76d1\u542c\u4e8b\u4ef6\uff0c\u5904\u7406\u670d\u52a1\u95f4\u901a\u4fe1\n// \u91cd\u547d\u540d EventLoop \u4e3a Listen\nfunc (k *MicroKernel) Listen(ctx context.Context) {\n\tfor {\n\t\tselect {\n\t\tcase <-ctx.Done():\n\t\t\treturn\n\t\tcase evt := <-k.eventCh:\n\t\t\tfmt.Printf("[MicroKernel] Event from %s: - %s\\n", evt.From, evt.Content)\n\t\t\t// \u53d1\u9001\u7ed9 MicroKernel \u81ea\u5df1\n\t\t\tif evt.To == "" {\n\t\t\t\tif evt.ReplyCh != nil {\n\t\t\t\t\tevt.ReplyCh <- Reply{Code: 0, Message: "Handled by kernel", Data: "ok"}\n\t\t\t\t}\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\t// \u8def\u7531\u5230\u76ee\u6807\u670d\u52a1\n\t\t\tk.mu.RLock()\n\t\t\tmeta, ok := k.services[evt.To]\n\t\t\tk.mu.RUnlock()\n\n\t\t\tif !ok || meta.state != Running {\n\t\t\t\tif evt.ReplyCh != nil {\n\t\t\t\t\tevt.ReplyCh <- Reply{Code: 404, Message: "service unavailable", Data: ""}\n\t\t\t\t}\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\t// \u8c03\u7528\u76ee\u6807\u670d\u52a1\u5904\u7406\uff0c\u5e76\u8fd4\u56de\n\t\t\tgo func(s Service, m Event) {\n\t\t\t\tresult := s.Handle(m)\n\t\t\t\tif m.ReplyCh != nil {\n\t\t\t\t\tselect {\n\t\t\t\t\tcase m.ReplyCh <- result:\n\t\t\t\t\tcase <-time.After(time.Duration(m.TimeoutMs) * time.Millisecond):\n\t\t\t\t\t\tm.ReplyCh <- Reply{Code: 408, Message: "timeout", Data: ""}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}(meta.svc, evt)\n\t\t}\n\t}\n}\n\n'})}),"\n",(0,i.jsx)(t.hr,{}),"\n",(0,i.jsx)(t.h3,{id:"22-\u8fd0\u884c\u7ed3\u679c",children:"2.2 \u8fd0\u884c\u7ed3\u679c"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"Registered: logger\nRegistered: echo\nStarting all services...\n[logger] starting...\n[echo] starting...\n[logger] LOG: Hello, Microkernel!\n[MicroKernel] Event from logger: - Hello, Microkernel!\n[logger] got reply from kernel: Handled by kernel\n[logger] LOG: Hello, Echo!\n[MicroKernel] Event from logger: - Hello, Echo!\n[logger] got reply from kernel: echo service handled\n[MicroKernel] Send Event to unknown: Hello, Log!\n{404 Not found service }\n[logger] stopping...\n[echo] stopping...\n"})}),"\n",(0,i.jsxs)(t.p,{children:["\u67e5\u770b",(0,i.jsx)(t.a,{href:"https://gitee.com/weidongkl/weidongkl.github.io/blob/master/docs/note/golang/design/microkernel/microkernel5",children:"\u5b8c\u6574\u4ee3\u7801"})]})]})}function g(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>l,x:()=>s});var r=n(96540);const i={},o=r.createContext(i);function l(e){const t=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),r.createElement(o.Provider,{value:t},e.children)}}}]);