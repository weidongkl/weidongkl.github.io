"use strict";(self.webpackChunkweidongkl_github_io=self.webpackChunkweidongkl_github_io||[]).push([[3496],{1904:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>h,contentTitle:()=>c,default:()=>a,frontMatter:()=>d,metadata:()=>l,toc:()=>i});const l=JSON.parse('{"id":"note/os/network/ssh_tunnel","title":"ssh\u53cd\u5411\u96a7\u9053\u8ba9\u9694\u79bb\u4e3b\u673a\u5916\u7f51","description":"1. \u573a\u666f\u63cf\u8ff0\u4e0e\u76ee\u6807","source":"@site/docs/note/os/network/ssh_tunnel.md","sourceDirName":"note/os/network","slug":"/note/os/network/ssh_tunnel","permalink":"/docs/note/os/network/ssh_tunnel","draft":false,"unlisted":false,"editUrl":"https://github.com/weidongkl/weidongkl.github.io/tree/master/docs/note/os/network/ssh_tunnel.md","tags":[],"version":"current","lastUpdatedBy":"weidongkl","lastUpdatedAt":1752116290000,"frontMatter":{},"sidebar":"note","previous":{"title":"\u7f51\u8def","permalink":"/docs/category/\u7f51\u8def"},"next":{"title":"chroot \u7528\u6cd5","permalink":"/docs/note/os/chroot"}}');var r=n(4848),t=n(8453);const d={},c="ssh\u53cd\u5411\u96a7\u9053\u8ba9\u9694\u79bb\u4e3b\u673a\u5916\u7f51",h={},i=[{value:"1. \u573a\u666f\u63cf\u8ff0\u4e0e\u76ee\u6807",id:"1-\u573a\u666f\u63cf\u8ff0\u4e0e\u76ee\u6807",level:2},{value:"2. \u65b9\u6cd5\u6982\u89c8\uff08SSH \u53cd\u5411 SOCKS5 \u96a7\u9053\uff09",id:"2-\u65b9\u6cd5\u6982\u89c8ssh-\u53cd\u5411-socks5-\u96a7\u9053",level:2},{value:"3. \u624b\u52a8\u65b9\u5f0f\uff08\u4e34\u65f6\u6d4b\u8bd5\u7528\uff09",id:"3-\u624b\u52a8\u65b9\u5f0f\u4e34\u65f6\u6d4b\u8bd5\u7528",level:2},{value:"3.1 A \u4e0a\u8fd0\u884c\u672c\u5730 SOCKS5 \u4ee3\u7406",id:"31-a-\u4e0a\u8fd0\u884c\u672c\u5730-socks5-\u4ee3\u7406",level:3},{value:"3.2 A \u4e0a\u5efa\u7acb\u53cd\u5411 SSH \u96a7\u9053\u5230 B",id:"32-a-\u4e0a\u5efa\u7acb\u53cd\u5411-ssh-\u96a7\u9053\u5230-b",level:3},{value:"3.3 B \u4e0a\u6d4b\u8bd5\u8bbf\u95ee",id:"33-b-\u4e0a\u6d4b\u8bd5\u8bbf\u95ee",level:3},{value:"4. \u81ea\u52a8\u5316\u90e8\u7f72\u811a\u672c\u4e0e\u670d\u52a1",id:"4-\u81ea\u52a8\u5316\u90e8\u7f72\u811a\u672c\u4e0e\u670d\u52a1",level:2},{value:"4.1 \u811a\u672c <code>/etc/ssh-tunnel/reverse-socks-tunnel.sh</code>",id:"41-\u811a\u672c-etcssh-tunnelreverse-socks-tunnelsh",level:3},{value:"4.2 systemd \u670d\u52a1 <code>/etc/systemd/system/ssh-reverse-tunnel.service</code>",id:"42-systemd-\u670d\u52a1-etcsystemdsystemssh-reverse-tunnelservice",level:3},{value:"4.3 \u542f\u52a8\u670d\u52a1",id:"43-\u542f\u52a8\u670d\u52a1",level:3},{value:"5. \u5e38\u89c1\u9519\u8bef\u6392\u67e5",id:"5-\u5e38\u89c1\u9519\u8bef\u6392\u67e5",level:2},{value:"6. \u5b89\u5168\u5efa\u8bae",id:"6-\u5b89\u5168\u5efa\u8bae",level:2},{value:"7. \u62d3\u5c55\u5efa\u8bae",id:"7-\u62d3\u5c55\u5efa\u8bae",level:2}];function o(e){const s={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"ssh\u53cd\u5411\u96a7\u9053\u8ba9\u9694\u79bb\u4e3b\u673a\u5916\u7f51",children:"ssh\u53cd\u5411\u96a7\u9053\u8ba9\u9694\u79bb\u4e3b\u673a\u5916\u7f51"})}),"\n",(0,r.jsx)(s.h2,{id:"1-\u573a\u666f\u63cf\u8ff0\u4e0e\u76ee\u6807",children:"1. \u573a\u666f\u63cf\u8ff0\u4e0e\u76ee\u6807"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"\u89d2\u8272"}),(0,r.jsx)(s.th,{children:"\u7f51\u7edc\u72b6\u6001"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"\u673a\u5668 A\uff08\u8df3\u677f\u673a\uff09"}),(0,r.jsx)(s.td,{children:"\u53ef\u8bbf\u95ee\u4e92\u8054\u7f51\uff0c\u53ef\u901a\u8fc7 SSH \u8fde\u63a5\u5230 B"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"\u673a\u5668 B\uff08\u9694\u79bb\u673a\uff09"}),(0,r.jsx)(s.td,{children:"\u65e0\u6cd5\u8bbf\u95ee\u4e92\u8054\u7f51\uff0c\u65e0\u6cd5\u4e3b\u52a8\u8fde\u63a5 A"})]})]})]}),"\n",(0,r.jsx)(s.p,{children:"\u76ee\u6807\uff1a\u8ba9 B \u80fd\u8bbf\u95ee\u5916\u7f51\uff08\u5982 curl\u3001yum\u3001apt\u3001wget \u53ef\u7528\uff09\uff0c\u901a\u8fc7 A \u7684\u7f51\u7edc\u4ee3\u7406\u51fa\u7f51\u3002"}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"2-\u65b9\u6cd5\u6982\u89c8ssh-\u53cd\u5411-socks5-\u96a7\u9053",children:"2. \u65b9\u6cd5\u6982\u89c8\uff08SSH \u53cd\u5411 SOCKS5 \u96a7\u9053\uff09"}),"\n",(0,r.jsx)(s.p,{children:"\u601d\u8def\uff1a"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"\u5728\u673a\u5668 A \u4e0a\u8fd0\u884c\u672c\u5730 SOCKS5 \u4ee3\u7406\uff1b"}),"\n",(0,r.jsx)(s.li,{children:"\u901a\u8fc7 SSH \u5c06 A \u7684\u4ee3\u7406\u7aef\u53e3\u53cd\u5411\u8f6c\u53d1\u7ed9 B\uff1b"}),"\n",(0,r.jsxs)(s.li,{children:["\u5728 B \u4e0a\u914d\u7f6e\u672c\u5730 ",(0,r.jsx)(s.code,{children:"localhost:1080"})," \u4e3a SOCKS5 \u4ee3\u7406\u8bbf\u95ee\u5916\u7f51\u3002"]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"3-\u624b\u52a8\u65b9\u5f0f\u4e34\u65f6\u6d4b\u8bd5\u7528",children:"3. \u624b\u52a8\u65b9\u5f0f\uff08\u4e34\u65f6\u6d4b\u8bd5\u7528\uff09"}),"\n",(0,r.jsx)(s.h3,{id:"31-a-\u4e0a\u8fd0\u884c\u672c\u5730-socks5-\u4ee3\u7406",children:"3.1 A \u4e0a\u8fd0\u884c\u672c\u5730 SOCKS5 \u4ee3\u7406"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"ssh -q -N -D 1080 localhost\n"})}),"\n",(0,r.jsxs)(s.p,{children:["\u76d1\u542c\u672c\u5730 ",(0,r.jsx)(s.code,{children:"127.0.0.1:1080"}),"\uff0c\u63d0\u4f9b SOCKS5 \u670d\u52a1\u3002"]}),"\n",(0,r.jsx)(s.h3,{id:"32-a-\u4e0a\u5efa\u7acb\u53cd\u5411-ssh-\u96a7\u9053\u5230-b",children:"3.2 A \u4e0a\u5efa\u7acb\u53cd\u5411 SSH \u96a7\u9053\u5230 B"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"ssh -fNT -R 1080:localhost:1080 user@B_IP\n"})}),"\n",(0,r.jsx)(s.p,{children:"\u542b\u4e49\uff1a"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"B \u7684 1080 \u2192 A \u7684 localhost:1080\uff1b"}),"\n",(0,r.jsxs)(s.li,{children:["B \u4e0a\u7684 ",(0,r.jsx)(s.code,{children:"localhost:1080"})," \u5b9e\u9645\u5c31\u662f A \u4e0a\u7684\u4ee3\u7406\u670d\u52a1\u3002"]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"33-b-\u4e0a\u6d4b\u8bd5\u8bbf\u95ee",children:"3.3 B \u4e0a\u6d4b\u8bd5\u8bbf\u95ee"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"curl -x socks5://localhost:1080 http://ip.sb\n"})}),"\n",(0,r.jsx)(s.p,{children:"\u6216\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\uff1a"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'export http_proxy="socks5://localhost:1080"\nexport https_proxy="socks5://localhost:1080"\n'})}),"\n",(0,r.jsx)(s.p,{children:"\u5982\u6210\u529f\uff0c\u5e94\u8f93\u51fa A \u7684\u516c\u7f51 IP\u3002"}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"4-\u81ea\u52a8\u5316\u90e8\u7f72\u811a\u672c\u4e0e\u670d\u52a1",children:"4. \u81ea\u52a8\u5316\u90e8\u7f72\u811a\u672c\u4e0e\u670d\u52a1"}),"\n",(0,r.jsxs)(s.h3,{id:"41-\u811a\u672c-etcssh-tunnelreverse-socks-tunnelsh",children:["4.1 \u811a\u672c ",(0,r.jsx)(s.code,{children:"/etc/ssh-tunnel/reverse-socks-tunnel.sh"})]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'#!/bin/bash\n\nREMOTE_USER="buser"\nREMOTE_HOST="192.168.100.2"\nREMOTE_PORT="1080"\nLOCAL_SOCKS_PORT="1080"\n\nif ! pgrep -f "ssh -D ${LOCAL_SOCKS_PORT}" >/dev/null; then\n    nohup ssh -q -N -D ${LOCAL_SOCKS_PORT} localhost >/dev/null 2>&1 &\nfi\n\nsleep 1\n\nautossh -M 0 -fNT -o ServerAliveInterval=30 -o ServerAliveCountMax=3 \\\n    -R ${REMOTE_PORT}:localhost:${LOCAL_SOCKS_PORT} \\\n    ${REMOTE_USER}@${REMOTE_HOST}\n'})}),"\n",(0,r.jsxs)(s.h3,{id:"42-systemd-\u670d\u52a1-etcsystemdsystemssh-reverse-tunnelservice",children:["4.2 systemd \u670d\u52a1 ",(0,r.jsx)(s.code,{children:"/etc/systemd/system/ssh-reverse-tunnel.service"})]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ini",children:"[Unit]\nDescription=SSH Reverse SOCKS5 Tunnel to Machine B\nAfter=network.target\n\n[Service]\nExecStart=/etc/ssh-tunnel/reverse-socks-tunnel.sh\nRestart=always\nRestartSec=10\nUser=root\n\n[Install]\nWantedBy=multi-user.target\n"})}),"\n",(0,r.jsx)(s.h3,{id:"43-\u542f\u52a8\u670d\u52a1",children:"4.3 \u542f\u52a8\u670d\u52a1"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"chmod +x /etc/ssh-tunnel/reverse-socks-tunnel.sh\nsystemctl daemon-reexec\nsystemctl enable --now ssh-reverse-tunnel.service\n"})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"5-\u5e38\u89c1\u9519\u8bef\u6392\u67e5",children:"5. \u5e38\u89c1\u9519\u8bef\u6392\u67e5"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"\u95ee\u9898"}),(0,r.jsx)(s.th,{children:"\u539f\u56e0"}),(0,r.jsx)(s.th,{children:"\u89e3\u51b3\u65b9\u6cd5"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"curl: (7) Unable to receive initial SOCKS5 response"}),(0,r.jsx)(s.td,{children:"A \u672a\u8fd0\u884c SOCKS5 \u6216\u96a7\u9053\u672a\u8fde\u901a"}),(0,r.jsxs)(s.td,{children:["\u68c0\u67e5\u662f\u5426\u542f\u52a8 ",(0,r.jsx)(s.code,{children:"ssh -D"}),"\u3001\u662f\u5426\u5efa\u7acb ",(0,r.jsx)(s.code,{children:"-R"})," \u96a7\u9053"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"B \u65e0\u6cd5\u8fde\u63a5 localhost:1080"}),(0,r.jsx)(s.td,{children:"\u96a7\u9053\u672a\u5efa\u7acb\u6210\u529f\u6216\u5df2\u65ad\u5f00"}),(0,r.jsx)(s.td,{children:"\u7528 `ss -tnlp"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"A \u672c\u5730 SOCKS5 \u5931\u8d25"}),(0,r.jsx)(s.td,{children:"\u7aef\u53e3\u51b2\u7a81\u6216 ssh \u547d\u4ee4\u9519\u8bef"}),(0,r.jsxs)(s.td,{children:["\u7528 ",(0,r.jsx)(s.code,{children:'pgrep -af "ssh -D"'})," \u68c0\u67e5\u4ee3\u7406\u662f\u5426\u6b63\u5e38\u8fd0\u884c"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Warning: remote port forwarding failed for listen port 1080"}),(0,r.jsx)(s.td,{children:"\u8fdc\u7a0b\u7aef\u53e3\u88ab\u5360\u7528/sshd \u914d\u7f6e\u4e0d\u5141\u8bb8\u8f6c\u53d1"}),(0,r.jsxs)(s.td,{children:["\u7aef\u53e3\u5360\u7528\u53ef\u5207\u6362\u7aef\u53e3/sshd \u914d\u7f6e\u53ef\u4ee5\u6253\u5f00\u5982\u4e0b\u914d\u7f6e\uff0c\u5141\u8bb8\u8f6c\u53d1\uff1a",(0,r.jsx)("br",{}),(0,r.jsx)(s.code,{children:"GatewayPorts yes"}),(0,r.jsx)("br",{}),(0,r.jsx)(s.code,{children:" AllowTcpForwarding yes"})]})]})]})]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"6-\u5b89\u5168\u5efa\u8bae",children:"6. \u5b89\u5168\u5efa\u8bae"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["\u5728 B \u7684 ",(0,r.jsx)(s.code,{children:"sshd_config"})," \u4e2d\u9650\u5236\u5141\u8bb8 SSH \u7528\u6237\uff1b"]}),"\n",(0,r.jsx)(s.li,{children:"\u4f7f\u7528\u4e13\u7528\u7528\u6237\u4ec5\u7528\u4e8e\u96a7\u9053\u8f6c\u53d1\uff1b"}),"\n",(0,r.jsx)(s.li,{children:"\u53ef\u542f\u7528\u516c\u94a5\u8ba4\u8bc1\uff0c\u7981\u7528\u5bc6\u7801\u767b\u5f55\u3002"}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"7-\u62d3\u5c55\u5efa\u8bae",children:"7. \u62d3\u5c55\u5efa\u8bae"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["\u5728 B \u4e0a\u5b89\u88c5 ",(0,r.jsx)(s.code,{children:"proxychains"})," \u4f7f\u4efb\u610f\u547d\u4ee4\u8d70\u4ee3\u7406\uff1b"]}),"\n",(0,r.jsxs)(s.li,{children:["\u4f7f\u7528 ",(0,r.jsx)(s.code,{children:"redsocks"})," + ",(0,r.jsx)(s.code,{children:"iptables"})," \u5c06\u7cfb\u7edf\u6d41\u91cf\u900f\u660e\u8f6c\u53d1\u81f3 SOCKS5\uff1b"]}),"\n",(0,r.jsx)(s.li,{children:"\u53ef\u7528 VPN \u66ff\u4ee3 SSH \u96a7\u9053\uff08\u5982 Tailscale\u3001Zerotier\uff09\u5b9e\u73b0\u5168\u7f51\u4e92\u901a\u3002"}),"\n"]})]})}function a(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>d,x:()=>c});var l=n(6540);const r={},t=l.createContext(r);function d(e){const s=l.useContext(t);return l.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),l.createElement(t.Provider,{value:s},e.children)}}}]);